<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>GSK LAND ‚Äî –±–∏–∑–Ω–µ—Å-–∏–≥—Ä–∞ v1.4.4</title>
<meta content="GSK LAND ‚Äî –±–∏–∑–Ω–µ—Å-–∏–≥—Ä–∞. –ú–∞–≥–∞–∑–∏–Ω, –º–æ–∏ –±–∏–∑–Ω–µ—Å—ã, —Ä–µ–π—Ç–∏–Ω–≥, –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å." name="description"/>
<style>
    /* Emerald - dark liquid glass theme */
    :root{
      --bg:#071018;
      --panel: rgba(255,255,255,0.03);
      --panel-2: rgba(255,255,255,0.02);
      --glass-border: rgba(255,255,255,0.04);
      --accent-start:#0fb48b; /* emerald */
      --accent-end:#1aa6d9; /* cyan */
      --card-radius:18px;
      --muted:#9fb3bf;
      --text:#e8f6f4;
    
      --wheel-bg1:#222;
      --wheel-bg2:#333;
      --wheel-text:#fff;
}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;background: radial-gradient(800px 400px at 10% 10%, rgba(26,166,217,0.06), transparent), radial-gradient(1000px 500px at 90% 80%, rgba(15,180,139,0.06), transparent), var(--bg); color:var(--text)}
    .app{max-width:1100px;margin:64px auto;padding:28px;backdrop-filter: blur(10px) saturate(120%); background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border-radius:24px; border:1px solid var(--glass-border); box-shadow: 0 12px 40px rgba(2,6,23,0.7);}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:22px;letter-spacing:0.4px}
    nav{display:flex;gap:8px}
    .nav-btn{padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--glass-border);cursor:pointer;color:var(--text)}
    .nav-btn.active{box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25);}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    .col{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03)); padding:18px;border-radius:var(--card-radius); border:1px solid var(--glass-border)}
    .card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid var(--glass-border);margin-bottom:12px}
    .shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .biz-card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));border:1px solid var(--glass-border)}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white;text-decoration:none;border:none;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    input,select,textarea{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;width:100%;box-sizing:border-box}
    .small{font-size:13px}
    .flex{display:flex;gap:8px;align-items:center}
    .right{justify-content:flex-end}
    .hidden{display:none !important}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    #hud{position:fixed;top:12px;left:50%;transform:translateX(-50%);height:56px;backdrop-filter:blur(10px);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:8px 16px;border:1px solid var(--glass-border);display:flex;align-items:center;gap:16px;z-index:1000;min-width:320px}
    .news-item{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
    .clicker-btn{padding:20px;font-size:18px;border-radius:15px;background:linear-gradient(90deg,#ff6b6b,#ff8e53);cursor:pointer;border:none;color:white;margin:10px 0}
    .progress-bar{height:20px;background:rgba(255,255,255,0.1);border-radius:10px;margin:10px 0;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));border-radius:10px;transition:width 0.3s}
    .achievement-card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border:1px solid var(--glass-border);margin-bottom:8px}
    .achievement-locked{opacity:0.6}
    .admin-table{width:100%;border-collapse:collapse;margin-top:10px}
    .admin-table th,.admin-table td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1)}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000}
    .modal-content{background:var(--bg);padding:20px;border-radius:var(--card-radius);border:1px solid var(--glass-border);max-width:400px;width:100%}
    .admin-tabs{display:flex;gap:8px;margin-bottom:16px}
    .admin-tab{padding:10px 16px;border-radius:10px;background:var(--panel);cursor:pointer;border:1px solid var(--glass-border)}
    .admin-tab.active{background:linear-gradient(90deg,var(--accent-start),var(--accent-end))}

    /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .notification-badge {
      background: #ff4757;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 8px;
    }

    .notification-toast {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
      color: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 10000;
      max-width: 350px;
      transform: translateX(400px);
      transition: transform 0.4s ease-out;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .notification-toast.show {
      transform: translateX(0);
    }

    .notification-toast h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .notification-toast p {
      margin: 4px 0;
      font-size: 14px;
    }

    .notification-toast .btn {
      margin-top: 10px;
      margin-right: 8px;
      background: rgba(255,255,255,0.2);
    }

    .notification-toast .btn.reject {
      background: rgba(200,60,60,0.8);
    }

    /* –ö–∞–∑–∏–Ω–æ (—Ä—É–ª–µ—Ç–∫–∞) ‚Äî —Å—Ç–∏–ª–∏ */
	.casino-card { padding:16px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.03); }
	.wheel-wrap{display:flex;gap:16px;align-items:center;justify-content:center;flex-wrap:wrap;}
	.wheel-container {
	  position: relative;
	  width: 360px;
	  height: 360px;
	  display: flex;
	  justify-content: center;
	  align-items: flex-start;
	}
	.wheel { 
	  width:360px; 
	  height:360px; 
	  border-radius:50%; 
	  position:relative; 
	  overflow:hidden; 
	  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
	  transform-origin: center center;
	}
	.wheel canvas{ 
	  width:100%; 
	  height:100%; 
	  transform: translateZ(0);
	}
	.wheel-pointer{ 
	  position: absolute;
	  top: -5px;
	  left: 50%;
	  transform: translateX(-50%);
	  width: 0;
	  height: 0;
	  border-left: 15px solid transparent;
	  border-right: 15px solid transparent;
	  border-top: 25px solid #ff4757;
	  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));
	  z-index: 100;
	  pointer-events: none;
	}
	.casino-controls{ max-width:360px; margin-top: 20px; }
	.casino-controls input[type=number]{ width:100%; }
	.casino-info{ margin-top:12px }
	@media (max-width:900px){ 
	  .wheel{ width:280px;height:280px } 
	  .wheel-container { width: 280px; height: 280px; }
	}
  
/* üì± –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
@media (max-width: 600px) {
  body, html { margin: 0; padding: 0; }
  .app { margin: 16px auto; padding: 16px; width: 100%; border-radius: 12px; }
  header { flex-direction: column; align-items: flex-start; gap: 8px; }
  nav { display: flex; flex-wrap: wrap; gap: 6px; width: 100%; overflow-x: auto; }
  .nav-btn { flex: 1 1 auto; min-width: 100px; text-align: center; font-size: 15px; padding: 8px; }
  h1 { font-size: 18px; text-align: left; }
  .grid { grid-template-columns: 1fr; gap: 12px; }
  aside { order: 2; }
  main { order: 1; }
  #hud { flex-direction: column; align-items: flex-start; gap: 6px; min-width: auto; width: calc(100% - 24px); left: 12px; transform: none; }
  .wheel, .wheel-container { width: 220px !important; height: 220px !important; }
  .clicker-btn { width: 100%; font-size: 16px; padding: 16px; }
  input, select, textarea { font-size: 16px; padding: 12px; }
  button.btn { width: 100%; margin-top: 6px; }
  .flex { flex-wrap: wrap; gap: 6px; }
  .admin-table, .admin-table th, .admin-table td { font-size: 12px; }
}


/* üé® –¢–µ–º—ã: —Å–≤–µ—Ç–ª–∞—è –∏ —Ç—ë–º–Ω–∞—è */
:root[data-theme="light"] {
  --bg: #f5f5f7;
  --panel: rgba(0,0,0,0.05);
  --panel-2: rgba(0,0,0,0.03);
  --glass-border: rgba(0,0,0,0.08);
  --accent-start:#1aa6d9; /* cyan */
  --accent-end:#0fb48b; /* emerald */
  --card-radius:18px;
  --muted:#555;
  --text:#111;

  --wheel-bg1:#eee;
  --wheel-bg2:#ddd;
  --wheel-text:#111;
}

.theme-toggle {
  position: fixed;
  bottom: 16px;
  right: 16px;
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid var(--glass-border);
  background: linear-gradient(90deg,var(--accent-start),var(--accent-end));
  color: #fff;
  cursor: pointer;
  z-index: 20000;
  font-size: 14px;
}


/* üé∞ –§–∏–∫—Å: –∫–æ–ª–µ—Å–æ –∫–∞–∑–∏–Ω–æ –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–º—ã) */
.wheel, .wheel canvas {
  background: none !important;
  color: inherit !important;
}

</style>
</head>
<body>
<div class="hidden" id="hud">
<div style="display:flex;gap:10px;align-items:center"><strong id="hud-username"></strong><span class="muted" id="hud-email"></span></div>
<div style="margin-left:auto">–ë–∞–ª–∞–Ω—Å: <strong id="hud-balance">0</strong> ‚ÇΩ <span style="margin-left:10px">üíé: <strong id="hud-diamonds">0</strong></span></div>
</div>
<div class="hidden modal" id="sell-modal">
<div class="modal-content">
<h3>–ü—Ä–æ–¥–∞–∂–∞ –±–∏–∑–Ω–µ—Å–∞ –∏–≥—Ä–æ–∫—É</h3>
<input id="sell-username" placeholder="–ù–∏–∫–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞" style="margin-top:12px"/>
<input id="sell-price" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏" style="margin-top:8px" type="number"/>
<div class="flex" style="justify-content:space-between;margin-top:16px">
<button class="btn" id="sell-cancel">–û—Ç–º–µ–Ω–∞</button>
<button class="btn" id="sell-confirm">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å</button>
</div>
</div>
</div>
<div class="app" id="app">
<header>
<div>
<h1>GSK LAND ‚Äî –±–∏–∑–Ω–µ—Å-–∏–≥—Ä–∞</h1>
<div class="muted small">–°—Ç–∞–Ω—å —É—Å–ø–µ—à–Ω—ã–º –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–º!</div>
</div>

<nav id="nav">
  <button class="nav-btn active" data-view="home">–ì–ª–∞–≤–Ω–∞—è</button>
  <button class="nav-btn" data-view="businesses">–ë–∏–∑–Ω–µ—Å—ã</button>
  <button class="nav-btn" data-view="career">–ö–∞—Ä—å–µ—Ä–∞</button>
  <button class="nav-btn" data-view="entertainment">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</button>
  <button class="nav-btn" data-view="other">–ü—Ä–æ—á–µ–µ</button>
  <button class="nav-btn hidden" data-view="admin" id="nav-admin">–ê–¥–º–∏–Ω</button>
</nav>

</header>
<div class="grid">
<main class="col" id="main">
<section id="view-home">
<div class="card">
<h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GSK LAND</h2>
<p class="muted">–ü–æ–∫—É–ø–∞–π —Ä–µ–∞–ª—å–Ω—ã–µ –±–∏–∑–Ω–µ—Å—ã –≤ –≥–æ—Ä–æ–¥–µ, —Å–æ–±–∏—Ä–∞–π –¥–æ—Ö–æ–¥, –ø—Ä–æ–¥–∞–≤–∞–π –∏ –ø–æ–¥–Ω–∏–º–∞–π—Å—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ. –ö–∞–∂–¥—ã–π –±–∏–∑–Ω–µ—Å —É–Ω–∏–∫–∞–ª–µ–Ω –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–º—É –∏–≥—Ä–æ–∫—É.</p>
</div>
<div class="card" id="auth-area">
<div class="hidden" id="user-info">
<div class="flex" style="justify-content:space-between">
<div>
<strong id="display-name"></strong>
<div class="muted small" id="display-email"></div>
</div>
<div class="flex">
<div class="muted small">–ë–∞–ª–∞–Ω—Å:</div>
<div style="min-width:90px;text-align:right"><strong id="balance">0</strong> ‚ÇΩ</div>
</div>
</div>
<div class="flex" style="margin-top:10px">
<button class="btn" id="btn-logout">–í—ã–π—Ç–∏</button>
<button class="btn" id="btn-profile">–ü—Ä–æ—Ñ–∏–ª—å</button>
</div>
</div>
<div id="auth-forms">
<div style="display:flex;gap:12px;align-items:center">
<div style="flex:1">
<h3>–í—Ö–æ–¥</h3>
<input id="login-email" placeholder="Email"/>
<input id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-top:8px" type="password"/>
<div style="margin-top:8px"><button class="btn" id="btn-login">–í–æ–π—Ç–∏</button></div>
</div>
<div style="width:1px;background:rgba(255,255,255,0.02);height:160px"></div>
<div style="flex:1">
<h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<input id="reg-username" placeholder="–ù–∏–∫–Ω–µ–π–º"/>
<input id="reg-email" placeholder="Email" style="margin-top:8px"/>
<input id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-top:8px" type="password"/>
<input id="reg-pass2" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="margin-top:8px" type="password"/>
<input id="reg-codeword" placeholder="–ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ" style="margin-top:8px"/>
<div class="flex" style="margin-top:8px"><button class="btn" id="btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></div>
</div>
</div>
</div>
</div>
<div class="card">
<h3>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</h3>
<ol class="muted small">
<li>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –∏ —Å–æ–∑–¥–∞–π –Ω–∏–∫–Ω–µ–π–º.</li>
<li>–û—Ç–∫—Ä–æ–π –ú–∞–≥–∞–∑–∏–Ω –∏ –∫—É–ø–∏ —Å–≤–æ–±–æ–¥–Ω—ã–π –±–∏–∑–Ω–µ—Å (–∫–∞–∂–¥—ã–π –±–∏–∑–Ω–µ—Å –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–º—É –∏–≥—Ä–æ–∫—É).</li>
<li>–ó–∞—Ö–æ–¥–∏ –≤ —Ä–∞–∑–¥–µ–ª ¬´–ú–æ–∏ –±–∏–∑–Ω–µ—Å—ã¬ª –∏ —Å–æ–±–∏—Ä–∞–π –¥–æ—Ö–æ–¥ ‚Äî –∫–Ω–æ–ø–∫–∞ "–°–æ–±—Ä–∞—Ç—å" –Ω–∞—á–∏—Å–ª–∏—Ç –¥–æ—Ö–æ–¥ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±–æ—Ä–∞.</li>
<li>–ú–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å –±–∏–∑–Ω–µ—Å –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤—É (-30% –æ—Ç —Ü–µ–Ω—ã) –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–≥—Ä–æ–∫—É (—Ü–µ–Ω–∞ –æ—Ç 50% –¥–æ 200% –æ—Ç –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–π).</li>
<li>–°–ª–µ–¥–∏ –∑–∞ –±–∞–ª–∞–Ω—Å –≤ HUD –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞.</li>
</ol>
</div>
</section>

<section class="hidden" id="view-businesses">
  <h2>–ë–∏–∑–Ω–µ—Å—ã</h2>
  <div class="admin-tabs category-tabs" data-category="businesses">
    <button class="admin-tab active" data-tab="shop">–ú–∞–≥–∞–∑–∏–Ω</button>
    <button class="admin-tab" data-tab="my">–ú–æ–∏ –±–∏–∑–Ω–µ—Å—ã</button>
    <button class="admin-tab" data-tab="company">–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</button>
  </div>
</section>

<section class="hidden" id="view-career">
  <h2>–ö–∞—Ä—å–µ—Ä–∞</h2>
  <div class="admin-tabs category-tabs" data-category="career">
    <button class="admin-tab active" data-tab="clicker">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</button>
    <button class="admin-tab" data-tab="education">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</button>
    <button class="admin-tab" data-tab="rating">–†–µ–π—Ç–∏–Ω–≥</button>
  </div>
</section>

<section class="hidden" id="view-entertainment">
  <h2>–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</h2>
  <div class="admin-tabs category-tabs" data-category="entertainment">
    <button class="admin-tab active" data-tab="quests">–ó–∞–¥–∞–Ω–∏—è</button>
    <button class="admin-tab" data-tab="achievements">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
    <button class="admin-tab" data-tab="casino">–ö–∞–∑–∏–Ω–æ</button>
  </div>
</section>

<section class="hidden" id="view-other">
  <h2>–ü—Ä–æ—á–µ–µ</h2>
  <div class="admin-tabs category-tabs" data-category="other">
    <button class="admin-tab active" data-tab="news">–ù–æ–≤–æ—Å—Ç–∏</button>
    <button class="admin-tab" data-tab="promocodes">–ü—Ä–æ–º–æ–∫–æ–¥—ã</button>
    <button class="admin-tab" data-tab="help">–ü–æ–º–æ—â—å</button>
  </div>
</section>
<section class="hidden" id="view-shop">
<h2>–ú–∞–≥–∞–∑–∏–Ω –±–∏–∑–Ω–µ—Å–æ–≤</h2>
<div class="shop-grid" id="shop-list" style="margin-top:12px"></div>
</section>
<section class="hidden" id="view-my">
<h2>–ú–æ–∏ –±–∏–∑–Ω–µ—Å—ã</h2>
<div class="card">
<div class="flex" style="justify-content:space-between;align-items:center">
<div>–°–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –±–∏–∑–Ω–µ—Å–æ–≤. –ù–∞–∂–º–∏—Ç–µ "–°–æ–±—Ä–∞—Ç—å" —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –¥–æ—Ö–æ–¥.</div>
<div><button class="btn" id="collect-all">–°–æ–±—Ä–∞—Ç—å —Å–æ –≤—Å–µ—Ö</button></div>
</div>
</div>
<div id="my-list" style="margin-top:12px"></div>
</section>
<section class="hidden" id="view-rating">
<h2>–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h2>
<div id="rating-list" style="margin-top:12px"></div>
</section>
<section class="hidden" id="view-clicker">
<h2>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</h2>
<div class="card">
<p>–ö–ª–∏–∫–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –¥–µ–Ω—å–≥–∏! –ö–∞–∂–¥—ã–π –∫–ª–∏–∫ = 5 ‚ÇΩ</p>
<button class="clicker-btn" id="clicker-button">–ö–õ–ò–ö–ê–ô –ó–ê –î–ï–ù–¨–ì–ê–ú–ò!</button>
<div class="flex" style="justify-content:space-between">
<div>–ù–∞–∫–æ–ø–ª–µ–Ω–æ: <strong id="clicker-amount">0</strong> ‚ÇΩ</div>
<button class="btn" id="clicker-collect">–ó–∞–±—Ä–∞—Ç—å</button>
</div>
<div class="muted small">–í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤: <span id="total-clicks">0</span></div>
<div class="muted small">–ö–ª–∏–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è: <span id="daily-clicks">0</span></div>
</div>
</section>
<section class="hidden" id="view-quests">
<h2>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
<div id="quests-list" style="margin-top:12px"></div>
</section>
<section class="hidden" id="view-achievements">
<h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
<div id="achievements-list" style="margin-top:12px"></div>
</section>
<section class="hidden" id="view-promocodes">
<h2>–ü—Ä–æ–º–æ–∫–æ–¥—ã</h2>
<div class="card">
<input id="promocode-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥"/>
<div style="margin-top:8px"><button class="btn" id="promocode-activate">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button></div>
</div>
<div id="promocodes-list" style="margin-top:12px"></div>
</section>
<section class="hidden" id="view-news">
<h2>–ù–æ–≤–æ—Å—Ç–∏</h2>
<div id="news-list" style="margin-top:12px"></div>
<div class="hidden" id="news-admin" style="margin-top:20px">
<h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å</h3>
<input id="news-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"/>
<textarea id="news-content" placeholder="–¢–µ–∫—Å—Ç" style="margin-top:8px"></textarea>
<div style="margin-top:8px"><button class="btn" id="news-add">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div>
</div>
</section>
<section class="hidden" id="view-help">
      <h2>–ü–æ–º–æ—â—å</h2>
      <div class="card">
        <p><strong>–í–ù–ò–ú–ê–ù–ò–ï! –î–û–ù–ê–¢ –ü–†–û–ò–ó–í–û–î–ò–¢–°–Ø –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –ß–ï–†–ï–ó –¢–ï–•.–ü–û–î–î–ï–†–ñ–ö–£! –í–û–¢ –û–§–ò–¶–ò–ê–õ–¨–ù–´–ï –†–ï–°–£–†–°–´:</strong></p>
        <p>–¢–µ—Ö.–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ Telegram: <a href="https://t.me/gskland" target="_blank">https://t.me/gskland</a></p>
        <p>–¢–µ—Ö.–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ VK: <a href="https://vk.com/gskland" target="_blank">https://vk.com/gskland</a></p>
      </div>
    </section>

    <section class="hidden" id="view-casino">
  <h2>–ö–∞–∑–∏–Ω–æ ‚Äî –†—É–ª–µ—Ç–∫–∞</h2>
  <div class="card casino-card">
    <div class="wheel-wrap">
      <div class="wheel-container">
        <!-- –°—Ç—Ä–µ–ª–æ—á–∫–∞ –í–ù–ï –≤—Ä–∞—â–∞—é—â–µ–≥–æ—Å—è —ç–ª–µ–º–µ–Ω—Ç–∞ -->
        <div class="wheel-pointer"></div>
        <!-- –í—Ä–∞—â–∞—é—â–µ–µ—Å—è –∫–æ–ª–µ—Å–æ -->
        <div class="wheel" id="roulette-wheel">
          <canvas height="720" id="roulette-canvas" width="720"></canvas>
        </div>
      </div>
      <div class="casino-controls">
        <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∞ (‚ÇΩ) ‚Äî –æ—Ç 1000 –¥–æ 50000</label>
        <input id="spin-cost" max="50000" min="1000" step="100" type="number" value="1000"/>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" id="spin-btn">–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å</button>
        </div>
        <div class="casino-info muted small" id="casino-result">–°—Ç–∞–≤–∫–∞ –Ω–µ —Å–¥–µ–ª–∞–Ω–∞</div>
      </div>
    </div>
  </div>
</section>

<section class="hidden" id="view-education">
<h2>–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</h2>

<div class="card">
  <p class="muted">–†–∞–∑–¥–µ–ª "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ" –ø–æ–∫–∞ –ø—É—Å—Ç ‚Äî –∑–¥–µ—Å—å –±—É–¥—É—Ç –∫—É—Ä—Å—ã –∏ –ø—Ä–æ–∫–∞—á–∫–∞ –Ω–∞–≤—ã–∫–æ–≤.</p>
</div>

</section>

<section class="hidden" id="view-company">
<h2>–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</h2>

<div class="card">
  <p class="muted">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è ‚Äî –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å–æ–≤, –∞–∫—Ü–∏–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.</p>
</div>

</section>
<section class="hidden" id="view-admin">
<h2>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
<div class="admin-tabs">
<button class="admin-tab active" data-tab="users">–ò–≥—Ä–æ–∫–∏</button>
<button class="admin-tab" data-tab="businesses">–ë–∏–∑–Ω–µ—Å—ã</button>
<button class="admin-tab" data-tab="promocodes">–ü—Ä–æ–º–æ–∫–æ–¥—ã</button>
</div>
<div class="admin-tab-content" id="admin-users">
<div class="card">
<h3>–ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞</h3>
<input id="admin-search-user" placeholder="–ù–∏–∫–Ω–µ–π–º, email –∏–ª–∏ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ"/>
<div style="margin-top:8px"><button class="btn" id="admin-search-btn">–ù–∞–π—Ç–∏</button></div>
</div>
<div class="card">
<h3>–í—Å–µ –∏–≥—Ä–æ–∫–∏</h3>
<div id="admin-users-list"></div>
</div>
</div>
<div class="admin-tab-content hidden" id="admin-businesses">
<div class="card">
<h3>–°–æ–∑–¥–∞—Ç—å –±–∏–∑–Ω–µ—Å</h3>
<input id="admin-biz-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
<input id="admin-biz-price" placeholder="–¶–µ–Ω–∞" style="margin-top:8px" type="number"/>
<input id="admin-biz-income" placeholder="–î–æ—Ö–æ–¥ –≤ —á–∞—Å" style="margin-top:8px" type="number"/>
<input id="admin-biz-icon" placeholder="URL –∏–∫–æ–Ω–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" style="margin-top:8px"/>
<div style="margin-top:8px"><button class="btn" id="admin-create-biz">–°–æ–∑–¥–∞—Ç—å</button></div>
</div>
</div>
<div class="admin-tab-content hidden" id="admin-promocodes">
<div class="card">
<h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏</h3>
<input id="admin-promo-code" placeholder="–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞"/>
<input id="admin-promo-amount" placeholder="–°—É–º–º–∞" style="margin-top:8px" type="number"/>
<input id="admin-promo-uses" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π" style="margin-top:8px" type="number" value="1"/>
<div style="margin-top:8px">
<button class="btn" id="admin-create-promo">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
<button class="btn" id="admin-delete-promo" style="background:rgba(200,60,60,0.9);margin-top:8px">–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
</div>
</div>
</div>
</section>
</main>
<aside class="col">
<div class="card">
<h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è <span class="notification-badge hidden" id="notification-badge">0</span></h3>
<div id="notifications-list"></div>
</div>
<div class="card">
<h3>–ü–æ–∏—Å–∫ –±–∏–∑–Ω–µ—Å–∞</h3>
<input id="search-biz" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞"/>
<div style="margin-top:8px"><button class="btn" id="search-btn">–ù–∞–π—Ç–∏</button></div>
</div>
</aside>
</div>
<footer>GSK LAND</footer>
</div>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAZPTcPsHVAw1RiuOUhM9IXZTSWJdRAW-c",
      authDomain: "gskland2.firebaseapp.com",
      projectId: "gskland2",
      storageBucket: "gskland2.firebasestorage.app",
      messagingSenderId: "615778317319",
      appId: "1:615778317319:web:d875f784f280f5758926a2",
      measurementId: "G-GPWV7RJK8X"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    
    const navButtons = document.querySelectorAll('.nav-btn');
    const views = {
      home: document.getElementById('view-home'),
      shop: document.getElementById('view-shop'),
      my: document.getElementById('view-my'),
      rating: document.getElementById('view-rating'),
      clicker: document.getElementById('view-clicker'),
      quests: document.getElementById('view-quests'),
      achievements: document.getElementById('view-achievements'),
      promocodes: document.getElementById('view-promocodes'),
      news: document.getElementById('view-news'),
      casino: document.getElementById('view-casino'),
      help: document.getElementById('view-help'),
      admin: document.getElementById('view-admin')
    };

    // category names
    const topCategories = new Set(['businesses','career','entertainment','other']);

    // views that we may move between sections (store originals)
    const movableViewIds = ['shop','my','rating','clicker','quests','achievements','promocodes','news','help','casino','company','education'];

    const originalPositions = {};
    movableViewIds.forEach(id => {
      const el = document.getElementById('view-' + id);
      if (el) {
        originalPositions[id] = { parent: el.parentNode, nextSibling: el.nextSibling };
      }
    });

    function hideAllTopSections() {
      // hide all main-level view-* sections (but keep category containers for manual control)
      document.querySelectorAll('main > section[id^=\"view-\"]').forEach(s => s.classList.add('hidden'));
    }

    function restoreAllMovedViews() {
      for (const id in originalPositions) {
        const pos = originalPositions[id];
        const el = document.getElementById('view-' + id);
        if (!el) continue;
        if (pos.parent) {
          // restore to original position (insertBefore handles null nextSibling as append)
          pos.parent.insertBefore(el, pos.nextSibling);
          el.classList.add('hidden');
        }
      }
    }

    function showAtomicView(view) {
      // show a single existing view (like shop, clicker, etc.)
      restoreAllMovedViews();
      hideAllTopSections();
      const el = document.getElementById('view-' + view);
      if (el) el.classList.remove('hidden');

      // update nav active state for top-level buttons
      document.querySelectorAll('#nav .nav-btn').forEach(b => b.classList.remove('active'));
      // try to find a top-level button that maps to this view (rare)
      let parentBtn = document.querySelector('#nav .nav-btn[data-view=\"' + view + '\"]');
      if (parentBtn) parentBtn.classList.add('active');
      // but if not found, set Home as active? we'll leave none active in that case.

      // call initializer for specific views
      if (view === 'rating') renderRating();
      if (view === 'clicker') renderClicker();
      if (view === 'quests') renderQuests();
      if (view === 'achievements') renderAchievements();
      if (view === 'promocodes') renderPromocodes();
      if (view === 'news') renderNews();
      if (view === 'casino') initCasino();
      if (view === 'shop') renderShop();
      if (view === 'my') renderMyBusinesses();
      if (view === 'admin' && isAdminUser(currentUserDoc, currentUser)) renderAdminUsers();
    }

    function openCategory(category) {
      // Restore moved views to avoid accidental duplicates
      restoreAllMovedViews();
      hideAllTopSections();
      // Show the category container itself
      const section = document.getElementById('view-' + category);
      if (!section) return;
      section.classList.remove('hidden');

      // mark top nav active
      document.querySelectorAll('#nav .nav-btn').forEach(b => b.classList.remove('active'));
      const topBtn = document.querySelector('#nav .nav-btn[data-view=\"' + category + '\"]');
      if (topBtn) topBtn.classList.add('active');

      // determine active tab inside the category (admin-tab with .active or first)
      const tabs = section.querySelectorAll('.admin-tab');
      let activeTab = section.querySelector('.admin-tab.active');
      if (!activeTab) activeTab = tabs[0];
      if (!activeTab) return;
      const viewToShow = activeTab.dataset.tab;
      showViewInsideCategory(section, viewToShow);
    }

    function showViewInsideCategory(section, viewId) {
      // Move the desired view right after the category section (so it appears under the tabbar)
      const target = document.getElementById('view-' + viewId);
      if (!target) return;
      // hide everything first
      document.querySelectorAll('main > section[id^=\"view-\"]').forEach(s => s.classList.add('hidden'));
      // ensure the category section is visible
      section.classList.remove('hidden');
      // insert the target view immediately after the category section
      section.parentNode.insertBefore(target, section.nextSibling);
      // hide all managed views, then show target
      movableViewIds.forEach(id => {
        const el = document.getElementById('view-' + id);
        if (el) el.classList.add('hidden');
      });
      target.classList.remove('hidden');

      // call renderer for this view
      if (viewId === 'rating') renderRating();
      if (viewId === 'clicker') renderClicker();
      if (viewId === 'quests') renderQuests();
      if (viewId === 'achievements') renderAchievements();
      if (viewId === 'promocodes') renderPromocodes();
      if (viewId === 'news') renderNews();
      if (viewId === 'casino') initCasino();
      if (viewId === 'shop') renderShop();
      if (viewId === 'my') renderMyBusinesses();
    }

    // Attach nav listeners: top-level (home, categories, admin)
    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        if (!view) return;
        if (topCategories.has(view)) {
          openCategory(view);
        } else {
          showAtomicView(view);
        }
      });
    });

    // Attach tab listeners inside each category container (like admin-tabs)
    document.querySelectorAll('.category-tabs').forEach(tabsWrapper => {
      tabsWrapper.querySelectorAll('.admin-tab').forEach(tabBtn => {
        tabBtn.addEventListener('click', () => {
          // mark active in this group
          const parentSection = tabsWrapper.closest('section[id^=\"view-\"]');
          parentSection.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
          tabBtn.classList.add('active');
          // show the corresponding original view under the category
          showViewInsideCategory(parentSection, tabBtn.dataset.tab);
        });
      });
    });

    // make sure Home shows correctly by default
    // (original code marked home active initially)
    // showAtomicView('home');


    function isAdminUser(userDoc, user) {
      if (!user) return false;
      const email = user.email ? user.email.toLowerCase() : '';
      const username = userDoc ? userDoc.username : (user.displayName || '');
      return username === 'Spotty' || email === 'sad.spotty@gmail.com';
    }

    // –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
    function showNotificationToast(dealId, sellerName, bizName, price) {
      const existingToast = document.getElementById(`toast-${dealId}`);
      if (existingToast) existingToast.remove();

      const toast = document.createElement('div');
      toast.id = `toast-${dealId}`;
      toast.className = 'notification-toast';
      toast.innerHTML = `
        <h4>üíº –ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!</h4>
        <p><strong>–û—Ç:</strong> ${sellerName}</p>
        <p><strong>–ë–∏–∑–Ω–µ—Å:</strong> ${bizName}</p>
        <p><strong>–¶–µ–Ω–∞:</strong> ${price} ‚ÇΩ</p>
        <div class="flex">
          <button class="btn accept-btn" data-id="${dealId}">–ü—Ä–∏–Ω—è—Ç—å</button>
          <button class="btn reject-btn reject" data-id="${dealId}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
      `;

      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);

      toast.querySelector('.accept-btn').addEventListener('click', () => {
        acceptDeal(dealId);
        toast.remove();
      });

      toast.querySelector('.reject-btn').addEventListener('click', () => {
        rejectDeal(dealId);
        toast.remove();
      });

      setTimeout(() => { if (toast.parentNode) toast.remove(); }, 30000);
    }

    // Real-time listener –¥–ª—è —Å–¥–µ–ª–æ–∫ - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    function setupDealsListener() {
      if (!currentUser) return;

      if (dealsListener) dealsListener(); // —Å–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ä—ã–π listener, –µ—Å–ª–∏ –±—ã–ª

      console.log("Setting up deals listener for user:", currentUser.uid);

      dealsListener = db.collection('deals')
        .where('toUid', '==', currentUser.uid)
        .where('state', '==', 'pending')
        .onSnapshot(async (snapshot) => {
          console.log("Deals snapshot received:", snapshot.size, "deals");
          const notificationBadge = document.getElementById('notification-badge');
          const notificationsList = document.getElementById('notifications-list');

          // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
          notificationsList.innerHTML = '';
          let activeDealsCount = 0;

          // –∏—Å–ø–æ–ª—å–∑—É–µ–º for...of –≤–º–µ—Å—Ç–æ forEach, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª await
          for (const doc of snapshot.docs) {
            const deal = doc.data();
            deal.id = doc.id;
            activeDealsCount++;

            console.log("Processing deal:", deal.id, "from:", deal.fromUid);

            // –∂–¥—ë–º –ø–æ–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç—Ä–∏—Å—É–µ—Ç—Å—è
            await displayDealNotification(deal);

            // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º toast —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
            if (!deal.seen) {
              console.log("Deal not seen, showing toast");
              db.collection('deals').doc(deal.id).update({ seen: true });
              showDealNotification(deal);
            }
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
          if (activeDealsCount > 0) {
            notificationBadge.textContent = activeDealsCount;
            notificationBadge.classList.remove('hidden');
          } else {
            notificationBadge.classList.add('hidden');
          }
        }, (error) => {
          console.error('–û—à–∏–±–∫–∞ listener —Å–¥–µ–ª–æ–∫:', error);
        });
    }

    async function showDealNotification(deal) {
      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä—è–º–æ –∏–∑ deal
        const sellerName = deal.fromName || '–ò–≥—Ä–æ–∫';
        const bizName = deal.bizName || '–ë–∏–∑–Ω–µ—Å';

        showNotificationToast(deal.id, sellerName, bizName, deal.price);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
    async function displayDealNotification(deal) {
      try {
        console.log("Displaying deal notification:", deal.id);

        const notificationsList = document.getElementById('notifications-list');
        const notification = document.createElement('div');
        notification.className = 'news-item';
        notification.id = `notification-${deal.id}`;
        notification.innerHTML = `
          <strong>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ</strong>
          <div class="muted small">–û—Ç: ${deal.fromName || '–ò–≥—Ä–æ–∫'}</div>
          <div>–ë–∏–∑–Ω–µ—Å: ${deal.bizName || '–ë–∏–∑–Ω–µ—Å'}</div>
          <div>–¶–µ–Ω–∞: ${deal.price} ‚ÇΩ</div>
          <div class="flex" style="margin-top:8px;gap:8px">
            <button class="btn accept-deal" data-id="${deal.id}">–ü—Ä–∏–Ω—è—Ç—å</button>
            <button class="btn reject-deal" style="background:rgba(200,60,60,0.9)" data-id="${deal.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          </div>
        `;

        notificationsList.appendChild(notification);

        notification.querySelector('.accept-deal').addEventListener('click', () => acceptDeal(deal.id));
        notification.querySelector('.reject-deal').addEventListener('click', () => rejectDeal(deal.id));

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—è—Ç–∏—è —Å–¥–µ–ª–∫–∏
    async function acceptDeal(dealId) {
      try {
        console.log("Accepting deal:", dealId);
        
        await db.runTransaction(async (tx) => {
          const dealRef = db.collection('deals').doc(dealId);
          const dealDoc = await tx.get(dealRef);
          if (!dealDoc.exists) throw new Error('–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
          
          const dealData = dealDoc.data();
          if (dealData.state !== 'pending') throw new Error('–°–¥–µ–ª–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞');
          if (dealData.toUid !== currentUser.uid) throw new Error('–ù–µ –≤–∞—à–∞ —Å–¥–µ–ª–∫–∞');

          const buyerRef = db.collection('users').doc(currentUser.uid);
          const sellerRef = db.collection('users').doc(dealData.fromUid);
          const bizRef = db.collection('businesses').doc(dealData.bizId);

          const buyerDoc = await tx.get(buyerRef);
          const sellerDoc = await tx.get(sellerRef);
          const bizDoc = await tx.get(bizRef);

          const buyerData = buyerDoc.data();
          const sellerData = sellerDoc.data();
          const bizData = bizDoc.data();

          if (buyerData.balance < dealData.price) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
          if (bizData.ownerUid !== dealData.fromUid) throw new Error('–ë–∏–∑–Ω–µ—Å —É–∂–µ –ø—Ä–æ–¥–∞–Ω');

          tx.update(buyerRef, { balance: firebase.firestore.FieldValue.increment(-dealData.price) });
          tx.update(sellerRef, { balance: firebase.firestore.FieldValue.increment(dealData.price) });
          tx.update(bizRef, { ownerUid: currentUser.uid, lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp() });
          tx.update(dealRef, { state: 'accepted', acceptedAt: firebase.firestore.FieldValue.serverTimestamp() });
        });

        // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞
        const notificationEl = document.getElementById(`notification-${dealId}`);
        if (notificationEl) {
          notificationEl.remove();
        }
        
        alert('–°–¥–µ–ª–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!');
        await refreshUserDoc();
        await renderShop();
        await renderMyBusinesses();
        await renderRating();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        updateNotificationBadge();
        
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏
    async function rejectDeal(dealId) {
      try {
        console.log("Rejecting deal:", dealId);
        
        await db.collection('deals').doc(dealId).update({ 
          state: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞
        const notificationEl = document.getElementById(`notification-${dealId}`);
        if (notificationEl) {
          notificationEl.remove();
        }
        
        alert('–°–¥–µ–ª–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        updateNotificationBadge();
        
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function updateNotificationBadge() {
      const notifications = document.querySelectorAll('.news-item');
      const notificationBadge = document.getElementById('notification-badge');
      
      if (notifications.length > 0) {
        notificationBadge.textContent = notifications.length;
        notificationBadge.classList.remove('hidden');
      } else {
        notificationBadge.classList.add('hidden');
      }
    }

    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      
      document.getElementById('hud').classList.add('hidden');
      document.getElementById('user-info').classList.add('hidden');
      document.getElementById('auth-forms').classList.remove('hidden');
      document.getElementById('nav-admin').classList.add('hidden');
      document.getElementById('news-admin').classList.add('hidden');
      
      if (dealsListener) {
        dealsListener();
        dealsListener = null;
      }

      if (user) {
        try {
          const userRef = db.collection('users').doc(user.uid);
          const userSnap = await userRef.get();
          // --- Ensure diamonds and daily bonus defaults exist (added by assistant) ---
          try {
            const existing = userSnap.exists ? userSnap.data() : null;
            const defaults = {};
            if (!existing || existing.diamonds === undefined) defaults.diamonds = 0;
            if (!existing || existing.bonusDay === undefined) defaults.bonusDay = 1;
            if (!existing || existing.lastBonusClaim === undefined) defaults.lastBonusClaim = null;
            if (Object.keys(defaults).length > 0) {
              // merge defaults into user doc so existing logic can rely on these fields
              await userRef.set(defaults, { merge: true });
            }
            // refresh fetched data so currentUserDoc contains all fields
            const refreshed = await userRef.get();
            if (refreshed.exists) {
              currentUserDoc = refreshed.data();
            }
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–µ—Ñ–æ–ª—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', e);
          }
          // --- end defaults ---


          if (userSnap.exists) {
            currentUserDoc = userSnap.data();
          } else {
            const newUserData = { 
              username: user.displayName || '', 
              email: user.email || '', 
              balance: 10000,
              diamonds: 50,
              codeword: document.getElementById('reg-codeword')?.value || '',
              totalClicks: 0,
              clickerAmount: 0,
              achievements: { dailyQuest: false, thousandClicks: false, casinoQuestCompleted: false },
              questProgress: { dailyClicks: 0, casinoSpins: 0 },
              usedPromocodes: [],
              lastQuestReset: firebase.firestore.FieldValue.serverTimestamp(),
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            await userRef.set(newUserData);
            currentUserDoc = newUserData;
          }

          document.getElementById('user-info').classList.remove('hidden');
          document.getElementById('auth-forms').classList.add('hidden');
          // –ü–æ–∫–∞–∑–∞—Ç—å HUD –∏ –¥–∞–Ω–Ω—ã–µ
          document.getElementById('hud').classList.remove('hidden');
          if(document.getElementById('hud-username')) document.getElementById('hud-username').innerText = currentUserDoc.username || (user.displayName || '–ò–≥—Ä–æ–∫');
          if(document.getElementById('hud-diamonds')) document.getElementById('hud-diamonds').innerText = String(currentUserDoc.diamonds || 0);
          if(document.getElementById('display-diamonds')) document.getElementById('display-diamonds').innerText = String(currentUserDoc.diamonds || 0);
          if(document.getElementById('display-name')) document.getElementById('display-name').innerText = currentUserDoc.username || (user.displayName || '');
          if(document.getElementById('display-email')) document.getElementById('display-email').innerText = currentUserDoc.email || '';
          document.getElementById('display-name').innerText = currentUserDoc.username || user.displayName || '–ò–≥—Ä–æ–∫';
          document.getElementById('display-email').innerText = user.email || '';
          document.getElementById('balance').innerText = String(currentUserDoc.balance || 0);
          
          document.getElementById('hud').classList.remove('hidden');
          document.getElementById('hud-username').innerText = currentUserDoc.username || user.displayName || '–ò–≥—Ä–æ–∫';
          document.getElementById('hud-balance').innerText = String(currentUserDoc.balance || 0);
          if(document.getElementById('hud-diamonds')) document.getElementById('hud-diamonds').innerText = String(currentUserDoc.diamonds || 0);
          
          setupDealsListener();
          
          if (isAdminUser(currentUserDoc, user)) {
            document.getElementById('nav-admin').classList.remove('hidden');
            document.getElementById('news-admin').classList.remove('hidden');
          }
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
          alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–π—Ç–∏.');
          auth.signOut();
        }
      } else {
        currentUserDoc = null;
      }
      
      await renderShop();
      await renderMyBusinesses();
    });

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    document.getElementById('btn-register').addEventListener('click', async () => {
      const username = document.getElementById('reg-username').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const pass = document.getElementById('reg-pass').value;
      const pass2 = document.getElementById('reg-pass2').value;
      const codeword = document.getElementById('reg-codeword').value.trim();
      
      if (!username || !email || !pass || pass !== pass2 || !codeword) {
        alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
        return;
      }
      
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        await cred.user.updateProfile({ displayName: username });
        await db.collection('users').doc(cred.user.uid).set({ 
          username, 
          email, 
          balance: 10000,
          codeword,
          totalClicks: 0,
          clickerAmount: 0,
          achievements: {
            dailyQuest: false,
            thousandClicks: false
          },
          questProgress: {
            dailyClicks: 0
          },
          usedPromocodes: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GSK LAND!');
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + e.message);
      }
    });

    // –í—Ö–æ–¥
    document.getElementById('btn-login').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value.trim();
      const pass = document.getElementById('login-pass').value;
      
      try {
        await auth.signInWithEmailAndPassword(email, pass);
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + e.message);
      }
    });

    // –í—ã—Ö–æ–¥
    document.getElementById('btn-logout').addEventListener('click', () => {
      auth.signOut();
    });

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–¥–∞–∂–∏
    document.getElementById('sell-cancel').addEventListener('click', () => {
      document.getElementById('sell-modal').classList.add('hidden');
      currentSellBizId = null;
    });

    document.getElementById('sell-confirm').addEventListener('click', async () => {
      if (!currentSellBizId) return;
      
      const username = document.getElementById('sell-username').value.trim();
      const price = parseInt(document.getElementById('sell-price').value);
      
      if (!username) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞');
        return;
      }
      
      const bizRef = db.collection('businesses').doc(currentSellBizId);
      const bizDoc = await bizRef.get();
      
      if (!bizDoc.exists) {
        alert('–ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      
      const bizData = bizDoc.data();
      const minPrice = Math.floor(bizData.price * 0.5);
      const maxPrice = Math.floor(bizData.price * 2);
      
      if (isNaN(price) || price < minPrice || price > maxPrice) {
        alert(`–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç ${minPrice} –¥–æ ${maxPrice} ‚ÇΩ`);
        return;
      }
      
      try {
        const usersSnap = await db.collection('users').where('username', '==', username).get();
        
        if (usersSnap.empty) {
          alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        const targetUser = usersSnap.docs[0];
        
        await db.collection('deals').add({
          fromUid: currentUser.uid,
          fromName: currentUserDoc.username || currentUser.email || '–ò–≥—Ä–æ–∫',
          toUid: targetUser.id,
          bizId: currentSellBizId,
          bizName: bizData.name,
          price: price,
          state: 'pending',
          seen: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
        document.getElementById('sell-modal').classList.add('hidden');
        currentSellBizId = null;
        document.getElementById('sell-username').value = '';
        document.getElementById('sell-price').value = '';
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    });

    // –°–æ–±—Ä–∞—Ç—å –¥–æ—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö –±–∏–∑–Ω–µ—Å–æ–≤
    document.getElementById('collect-all').addEventListener('click', async () => {
      if (!currentUser) {
        alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      try {
        const serverNow = await getServerTime();
        const serverNowForBatch = await getServerTime();
        const snaps = await db.collection('businesses').where('ownerUid', '==', currentUser.uid).get();
        let totalIncome = 0;
        const batch = db.batch();
        const userRef = db.collection('users').doc(currentUser.uid);
        
        snaps.forEach(doc => {
          const bizData = doc.data();
          const lastCollected = bizData.lastCollectedAt ? bizData.lastCollectedAt.toDate() : serverNowForBatch;
          const hoursPassed = (serverNowForBatch - lastCollected) / (1000 * 60 * 60);
          const income = Math.floor(bizData.incomePerHour * hoursPassed);
          
          if (income > 0) {
            totalIncome += income;
            batch.update(doc.ref, { 
              lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp() 
            });
          }
        });
        
        if (totalIncome <= 0) {
          alert('–ù–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞');
          return;
        }
        
        batch.update(userRef, { 
          balance: firebase.firestore.FieldValue.increment(totalIncome) 
        });
        
        await batch.commit();
        alert(`–°–æ–±—Ä–∞–Ω–æ: ${totalIncome} ‚ÇΩ`);
        await refreshUserDoc();
        await renderMyBusinesses();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    });

    // –†–µ–Ω–¥–µ—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞
    async function renderRating() {
      const el = document.getElementById('rating-list');
            el.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>';
      
      try {
        const snaps = await db.collection('users').orderBy('balance', 'desc').limit(100).get();
        const users = [];
        
        snaps.forEach(doc => {
          const userData = doc.data();
          if (userData.username && userData.balance !== undefined) {
            users.push({
              username: userData.username,
              balance: userData.balance || 0
            });
          }
        });
        
        if (users.length === 0) {
          el.innerHTML = '<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
          return;
        }
        
        el.innerHTML = '';
        users.forEach((user, index) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <strong>#${index + 1} ${user.username}</strong>
            <div class="muted small">–ë–∞–ª–∞–Ω—Å: ${user.balance} ‚ÇΩ</div>
            
          `;
          el.appendChild(div);
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:', error);
        el.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
      }
    }

    // –ö–ª–∏–∫–µ—Ä
    async function renderClicker() {
      if (!currentUser) return;
      
      document.getElementById('clicker-amount').innerText = currentUserDoc.clickerAmount || 0;
      document.getElementById('total-clicks').innerText = currentUserDoc.totalClicks || 0;
      document.getElementById('daily-clicks').innerText = currentUserDoc.questProgress?.dailyClicks || 0;
    }

    document.getElementById('clicker-button').addEventListener('click', async () => {
      if (!currentUser) {
        alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      try {
        const userRef = db.collection('users').doc(currentUser.uid);
        await userRef.update({
          clickerAmount: firebase.firestore.FieldValue.increment(5),
          totalClicks: firebase.firestore.FieldValue.increment(1),
          'questProgress.dailyClicks': firebase.firestore.FieldValue.increment(1)
        });
        
        await refreshUserDoc();
        await renderClicker();
        await checkAchievements();
        await checkQuests();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    });

    document.getElementById('clicker-collect').addEventListener('click', async () => {
      if (!currentUser) {
        alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!currentUserDoc.clickerAmount || currentUserDoc.clickerAmount <= 0) {
        alert('–ù–µ—á–µ–≥–æ –∑–∞–±–∏—Ä–∞—Ç—å');
        return;
      }
      
      try {
        const userRef = db.collection('users').doc(currentUser.uid);
        await userRef.update({
          balance: firebase.firestore.FieldValue.increment(currentUserDoc.clickerAmount),
          clickerAmount: 0
        });
        
        alert(`–ó–∞–±—Ä–∞–Ω–æ ${currentUserDoc.clickerAmount} ‚ÇΩ!`);
        await refreshUserDoc();
        await renderClicker();
        await checkAchievements();
        } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    });

    // –ó–∞–¥–∞–Ω–∏—è
    async function ensureDailyQuestsReset() {
      if (!currentUser) return;
      try {
        const userRef = db.collection('users').doc(currentUser.uid);
        const doc = await userRef.get();
        const userData = doc.exists ? doc.data() : {};
        const lastReset = userData.lastQuestReset;
        const serverNow = await getServerTime();
        const today = serverNow.toISOString().slice(0,10);
        const last = lastReset ? lastReset.toDate().toISOString().slice(0,10) : null;
        if (last !== today) {
          await userRef.update({
            'questProgress.dailyClicks': 0,
            'questProgress.casinoSpins': 0,
            'achievements.dailyQuest': false,
            'achievements.casinoQuestCompleted': false,
            lastQuestReset: firebase.firestore.FieldValue.serverTimestamp()
          });
          await refreshUserDoc();
        }
      } catch (e) { console.error('ensureDailyQuestsReset error', e); }
    }

    
    // --- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å (7-–¥–Ω–µ–≤–Ω—ã–π —Ü–∏–∫–ª) ---
    async function claimDailyBonus(){ 
      if (!currentUser) { alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É'); return; }
      const rewards = {1:5000,2:10000,3:15000,4:15000,5:20000,6:35000,7:50000};
      try {
        const userRef = db.collection('users').doc(currentUser.uid);
        const userSnap = await userRef.get();
        if (!userSnap.exists) return;
        const data = userSnap.data() || {};
        const today = new Date().toDateString();
        if (data.lastBonusClaim === today) { alert('–ë–æ–Ω—É—Å —É–∂–µ –∑–∞–±—Ä–∞–Ω —Å–µ–≥–æ–¥–Ω—è!'); return; }
        const currentDay = data.bonusDay || 1;
        const reward = rewards[currentDay] || 5000;
        const nextDay = currentDay >= 7 ? 1 : currentDay + 1;
        await userRef.update({
          balance: firebase.firestore.FieldValue.increment(reward),
          bonusDay: nextDay,
          lastBonusClaim: today
        });
        alert('–í—ã –ø–æ–ª—É—á–∏–ª–∏ ' + reward + ' ‚ÇΩ!');
        await refreshUserDoc();
        // update HUD balance and diamonds if present
        if (document.getElementById('hud-balance')) document.getElementById('hud-balance').innerText = String(currentUserDoc.balance || 0);
          if(document.getElementById('hud-diamonds')) document.getElementById('hud-diamonds').innerText = String(currentUserDoc.diamonds || 0);
        if (document.getElementById('hud-diamonds')) document.getElementById('hud-diamonds').innerText = String(currentUserDoc.diamonds || 0);
      } catch (e) {
        console.error('claimDailyBonus error', e);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ –±–æ–Ω—É—Å–∞');
      }
    }
    // --- end bonus ---
    async function renderQuests() {
      const list = document.getElementById('quests-list');
      list.innerHTML = '';

      if (!currentUser) {
        list.innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–∞–¥–∞–Ω–∏—è</div>';
        return;
      }

      await ensureDailyQuestsReset();
      await refreshUserDoc();

      const clicksProgress = currentUserDoc.questProgress?.dailyClicks || 0;
      const clicksCompleted = currentUserDoc.achievements?.dailyQuest || false;
      const casinoProgress = currentUserDoc.questProgress?.casinoSpins || 0;
      const casinoCompleted = currentUserDoc.achievements?.casinoQuestCompleted || false;

      const questCardClicks = document.createElement('div');
      questCardClicks.className = 'card';
      questCardClicks.innerHTML = `
        <h3>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
        <p>–°–¥–µ–ª–∞–π—Ç–µ 100 –∫–ª–∏–∫–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞"</p>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${Math.min((clicksProgress/100)*100,100)}%"></div>
        </div>
        <div class="muted small">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${clicksProgress}/100 –∫–ª–∏–∫–æ–≤</div>
        ${clicksCompleted ? 
          '<div class="btn" style="background:rgba(15,180,139,0.9);">–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!</div>' : 
          (clicksProgress >= 100 ? 
            '<button class="btn" id="claim-quest-clicks">–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É (10,000 ‚ÇΩ)</button>' : 
            '<div class="muted">–ó–∞–¥–∞–Ω–∏–µ –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>'
          )
        }
      `;
      list.appendChild(questCardClicks);

      const questCardCasino = document.createElement('div');
      questCardCasino.className = 'card';
      questCardCasino.innerHTML = `
        <h3>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Äî –ö–∞–∑–∏–Ω–æ</h3>
        <p>–°—ã–≥—Ä–∞–π—Ç–µ –≤ –∫–∞–∑–∏–Ω–æ 5 —Ä–∞–∑ (–ø—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –∫–æ–ª–µ—Å–æ 5 —Ä–∞–∑)</p>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${Math.min((casinoProgress/5)*100,100)}%"></div>
        </div>
        <div class="muted small">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${casinoProgress}/5 –ø—Ä–æ–∫—Ä—É—Ç–æ–∫</div>
        ${casinoCompleted ? 
          '<div class="btn" style="background:rgba(15,180,139,0.9);">–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!</div>' : 
          (casinoProgress >= 5 ? 
            '<button class="btn" id="claim-quest-casino">–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É (2,500 ‚ÇΩ)</button>' : 
            '<div class="muted">–ó–∞–¥–∞–Ω–∏–µ –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>'
          )
        }
      `;
      list.appendChild(questCardCasino);

      if (clicksProgress >= 100 && !clicksCompleted) {
        document.getElementById('claim-quest-clicks').addEventListener('click', async () => {
          try {
            const userRef = db.collection('users').doc(currentUser.uid);
            await userRef.update({
              balance: firebase.firestore.FieldValue.increment(10000),
              'achievements.dailyQuest': true
            });
            alert('–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: 10,000 ‚ÇΩ!');
            await refreshUserDoc();
            await renderQuests();
          } catch (err) {
            alert('–û—à–∏–±–∫–∞: ' + err.message);
          }
        });
      }

      if (casinoProgress >= 5 && !casinoCompleted) {
        document.getElementById('claim-quest-casino').addEventListener('click', async () => {
          try {
            const userRef = db.collection('users').doc(currentUser.uid);
            await userRef.update({
              balance: firebase.firestore.FieldValue.increment(2500),
              'achievements.casinoQuestCompleted': true
            });
            alert('–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: 2,500 ‚ÇΩ!');
            await refreshUserDoc();
            await renderQuests();
          } catch (err) {
            alert('–û—à–∏–±–∫–∞: ' + err.message);
          }
        });
      }
    
      // --- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å: –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ '–ó–∞–¥–∞–Ω–∏—è' ---
      try {
        const bonusCard = document.createElement('div');
        bonusCard.className = 'card';
        const bonusDay = currentUserDoc ? (currentUserDoc.bonusDay || 1) : 1;
        const rewardsMap = {1:5000,2:10000,3:15000,4:15000,5:20000,6:35000,7:50000};
        const reward = rewardsMap[bonusDay] || 5000;
        bonusCard.innerHTML = `
          <h3>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</h3>
          <p>–î–µ–Ω—å: <strong id="daily-bonus-day">${'${0}'}</strong> ‚Äî –ù–∞–≥—Ä–∞–¥–∞: <strong id="daily-bonus-amount">${'${0}'}</strong> ‚ÇΩ</p>
          <div class="flex"><button class="btn" id="claim-daily-bonus">–ó–∞–±—Ä–∞—Ç—å</button></div>
        `.replace('${0}', bonusDay).replace('${0}', reward);
        list.appendChild(bonusCard);
        const btn = document.getElementById('claim-daily-bonus');
        if (btn) btn.addEventListener('click', claimDailyBonus);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞', e);
      }
      // --- –∫–æ–Ω–µ—Ü –±–æ–Ω—É—Å–∞ ---
}

    // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    async function renderAchievements() {
      const list = document.getElementById('achievements-list');
      list.innerHTML = '';
      
      if (!currentUser) {
        list.innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>';
        return;
      }
      
      const totalClicks = currentUserDoc.totalClicks || 0;
      const thousandCompleted = currentUserDoc.achievements?.thousandClicks || false;
      
      const achievements = [
        {
          id: 'thousandClicks',
          title: '–ú–∞—Å—Ç–µ—Ä –∫–ª–∏–∫–æ–≤',
          description: '–°–¥–µ–ª–∞–π—Ç–µ 1000 –∫–ª–∏–∫–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞"',
          reward: '50,000 ‚ÇΩ',
          progress: totalClicks,
          target: 1000,
          completed: thousandCompleted
        }
      ];
      
      achievements.forEach(achievement => {
        const achievementCard = document.createElement('div');
        achievementCard.className = `achievement-card ${achievement.completed ? '' : 'achievement-locked'}`;
        achievementCard.innerHTML = `
          <h3>${achievement.title}</h3>
          <p>${achievement.description}</p>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${Math.min((achievement.progress / achievement.target) * 100, 100)}%"></div>
          </div>
          <div class="muted small">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${achievement.progress}/${achievement.target}</div>
          <div class="muted small">–ù–∞–≥—Ä–∞–¥–∞: ${achievement.reward}</div>
          ${achievement.completed ? 
            '<div class="btn" style="background:rgba(15,180,139,0.9);margin-top:8px">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ!</div>' : 
            (achievement.progress >= achievement.target ? 
              '<button class="btn" data-achievement="thousandClicks">–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É</button>' : 
              '<div class="muted">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ</div>'
            )
          }
        `;
        
        list.appendChild(achievementCard);
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã
      document.querySelectorAll('[data-achievement]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const achievementId = btn.dataset.achievement;
          
          if (achievementId === 'thousandClicks') {
            try {
              const userRef = db.collection('users').doc(currentUser.uid);
              await userRef.update({
                balance: firebase.firestore.FieldValue.increment(50000),
                'achievements.thousandClicks': true
              });
              
              alert('–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: 50,000 ‚ÇΩ!');
              await refreshUserDoc();
              await renderAchievements();
            } catch (err) {
              alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
          }
        });
      });
    }

    // –ü—Ä–æ–º–æ–∫–æ–¥—ã
    async function renderPromocodes() {
      const list = document.getElementById('promocodes-list');
      list.innerHTML = '';
      
      if (!currentUser) {
        list.innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã</div>';
        return;
      }
      
      try {
        const snaps = await db.collection('promocodes').get();
        // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –æ—Ç –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:', error);
      }
    }

    document.getElementById('promocode-activate').addEventListener('click', async () => {
      if (!currentUser) {
        alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const code = document.getElementById('promocode-input').value.trim().toUpperCase();
      
      if (!code) {
        alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥');
        return;
      }
      
      try {
        const promoSnap = await db.collection('promocodes').doc(code).get();
        
        if (!promoSnap.exists) {
          alert('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        const promo = promoSnap.data();
        
        if (currentUserDoc.usedPromocodes?.includes(code)) {
          alert('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥');
          return;
        }
        
        if (promo.uses <= 0) {
          alert('–ü—Ä–æ–º–æ–∫–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
          return;
        }
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–æ–º–æ–∫–æ–¥
        const userRef = db.collection('users').doc(currentUser.uid);
        const promoRef = db.collection('promocodes').doc(code);
        
        await db.runTransaction(async (tx) => {
          const userDoc = await tx.get(userRef);
          const promoDoc = await tx.get(promoRef);
          
          if (!userDoc.exists || !promoDoc.exists) throw new Error('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏');
          
          const userData = userDoc.data();
          const promoData = promoDoc.data();
          
          if (userData.usedPromocodes?.includes(code)) throw new Error('–ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω');
          if (promoData.uses <= 0) throw new Error('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
          
          tx.update(userRef, {
            balance: firebase.firestore.FieldValue.increment(promoData.amount),
            usedPromocodes: firebase.firestore.FieldValue.arrayUnion(code)
          });
          
          tx.update(promoRef, {
            uses: firebase.firestore.FieldValue.increment(-1),
            usedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
          });
        });
        
        alert(`–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –ü–æ–ª—É—á–µ–Ω–æ ${promo.amount} ‚ÇΩ`);
        document.getElementById('promocode-input').value = '';
        await refreshUserDoc();
        await renderPromocodes();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    });

    // –ê–¥–º–∏–Ω: —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
    document.getElementById('admin-create-promo').addEventListener('click', async () => {
      if (!currentUser || !isAdminUser(currentUserDoc, currentUser)) {
        alert('–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É');
        return;
      }
      
      const code = document.getElementById('admin-promo-code').value.trim().toUpperCase();
      const amount = parseInt(document.getElementById('admin-promo-amount').value);
      const uses = parseInt(document.getElementById('admin-promo-uses').value);
      
      if (!code || isNaN(amount) || isNaN(uses) || amount <= 0 || uses <= 0) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
        return;
      }
      
      try {
        await db.collection('promocodes').doc(code).set({
          code: code,
          amount: amount,
          uses: uses,
          createdBy: currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          usedBy: []
        });
        
        alert('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!');
        document.getElementById('admin-promo-code').value = '';
        document.getElementById('admin-promo-amount').value = '';
        document.getElementById('admin-promo-uses').value = '1';
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + err.message);
      }
    });

    // –ê–¥–º–∏–Ω: —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
    document.getElementById('admin-delete-promo').addEventListener('click', async () => {
      if (!currentUser || !isAdminUser(currentUserDoc, currentUser)) {
        alert('–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É');
        return;
      }
      
      const code = document.getElementById('admin-promo-code').value.trim().toUpperCase();
      
      if (!code) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
        return;
      }
      
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ${code}?`)) return;
        
      try {
        await db.collection('promocodes').doc(code).delete();
        alert('–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª–µ–Ω!');
        document.getElementById('admin-promo-code').value = '';
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
      }
    });

    // –ê–¥–º–∏–Ω: —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
    async function renderAdminUsers() {
      const list = document.getElementById('admin-users-list');
      list.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</div>';
      
      try {
        const snaps = await db.collection('users').get();
        
        if (snaps.empty) {
          list.innerHTML = '<div class="muted">–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤</div>';
          return;
        }
        
        const table = document.createElement('table');
        table.className = 'admin-table';
        table.innerHTML = `
          <tr>
            <th>–ù–∏–∫–Ω–µ–π–º</th>
            <th>Email</th>
            <th>–ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ</th>
            <th>–ë–∞–ª–∞–Ω—Å</th>
            <th>–ö–ª–∏–∫–æ–≤</th>
          </tr>
        `;
        
        snaps.forEach(doc => {
          const user = doc.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
            <td>${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
            <td>${user.codeword || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
            <td>${user.balance || 0} ‚ÇΩ</td>
            <td>${user.totalClicks || 0}</td>
          `;
          table.appendChild(row);
        });
        
        list.innerHTML = '';
        list.appendChild(table);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        list.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
      }
    }

    // –ê–¥–º–∏–Ω: –ø–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–æ–≤
    document.getElementById('admin-search-btn').addEventListener('click', async () => {
      if (!currentUser || !isAdminUser(currentUserDoc, currentUser)) {
        alert('–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É');
        return;
      }
      
      const query = document.getElementById('admin-search-user').value.trim().toLowerCase();
      
      if (!query) {
        await renderAdminUsers();
        return;
      }
      
      const list = document.getElementById('admin-users-list');
      list.innerHTML = '<div class="muted">–ü–æ–∏—Å–∫...</div>';
      
      try {
        const snaps = await db.collection('users').get();
        const results = [];
        
        snaps.forEach(doc => {
          const user = doc.data();
          if (user.username && (
            user.username.toLowerCase().includes(query) ||
            (user.email && user.email.toLowerCase().includes(query)) ||
            (user.codeword && user.codeword.toLowerCase().includes(query))
          )) {
            results.push(user);
          }
        });
        
        if (results.length === 0) {
          list.innerHTML = '<div class="muted">–ò–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
          return;
        }
        
        const table = document.createElement('table');
        table.className = 'admin-table';
        table.innerHTML = `
          <tr>
            <th>–ù–∏–∫–Ω–µ–π–º</th>
            <th>Email</th>
            <th>–ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ</th>
            <th>–ë–∞–ª–∞–Ω—Å</th>
            <th>–ö–ª–∏–∫–æ–≤</th>
          </tr>
        `;
        
        results.forEach(user => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
            <td>${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
            <td>${user.codeword || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
            <td>${user.balance || 0} ‚ÇΩ</td>
            <td>${user.totalClicks || 0}</td>
          `;
          table.appendChild(row);
        });
        
        list.innerHTML = '';
        list.appendChild(table);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
        list.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
      }
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    async function checkAchievements() {
      if (!currentUser) return;
      
      const totalClicks = currentUserDoc.totalClicks || 0;
      
      if (totalClicks >= 1000 && !currentUserDoc.achievements?.thousandClicks) {
        try {
          const userRef = db.collection('users').doc(currentUser.uid);
          await userRef.update({
            'achievements.thousandClicks': true
          });
          await refreshUserDoc();
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:', err);
        }
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π
    async function checkQuests() {
      if (!currentUser) return;

      const dailyClicks = currentUserDoc.questProgress?.dailyClicks || 0;
      const casinoProgress = currentUserDoc.questProgress?.casinoSpins || 0;

      let shouldRender = false;

      if (dailyClicks >= 100 && !currentUserDoc.achievements?.dailyQuest) {
        shouldRender = true;
      }
      if (casinoProgress >= 5 && !currentUserDoc.achievements?.casinoQuestCompleted) {
        shouldRender = true;
      }

      if (shouldRender) {
        await refreshUserDoc();
        await renderQuests();
      }
    }

    

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π
    document.getElementById('news-add').addEventListener('click', async () => {
      if (!currentUser) {
        alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!isAdminUser(currentUserDoc, currentUser)) {
        alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏');
        return;
      }
      
      const title = document.getElementById('news-title').value.trim();
      const content = document.getElementById('news-content').value.trim();
      
      if (!title || !content) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏');
        return;
      }
      
      try {
        await db.collection('news').add({
          title,
          content,
          author: currentUserDoc.username || currentUser.email || 'admin',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        document.getElementById('news-title').value = '';
        document.getElementById('news-content').value = '';
        alert('–ù–æ–≤–æ—Å—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞');
        await renderNews();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + err.message);
      }
    });

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    function setupNewsListener() {
      return db.collection('news')
        .orderBy('timestamp', 'desc')
        .onSnapshot((snap) => {
          const el = document.getElementById('news-list');
          el.innerHTML = '';
          
          snap.forEach((doc) => {
            const news = doc.data();
            const time = news.timestamp ? news.timestamp.toDate().toLocaleString() : '';
            
            const div = document.createElement('div');
            div.className = 'news-item';
            div.innerHTML = `
              <strong>${news.title}</strong>
              <div class="muted small">${news.author} ‚Ä¢ ${time}</div>
              <div style="margin-top:8px">${news.content}</div>
            `;
            
            el.appendChild(div);
          });
        });
    }

    // –†–µ–Ω–¥–µ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π
    async function renderNews() {
      const el = document.getElementById('news-list');
      el.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>';
      
      try {
        const snaps = await db.collection('news').orderBy('timestamp', 'desc').get();
        el.innerHTML = '';
        
        snaps.forEach((doc) => {
          const news = doc.data();
          const time = news.timestamp ? news.timestamp.toDate().toLocaleString() : '';
          
          const div = document.createElement('div');
          div.className = 'news-item';
          div.innerHTML = `
            <strong>${news.title}</strong>
            <div class="muted small">${news.author} ‚Ä¢ ${time}</div>
            <div style="margin-top:8px">${news.content}</div>
          `;
          
          el.appendChild(div);
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:', error);
        el.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π</div>';
      }
    }

    // –ü–æ–∏—Å–∫ –±–∏–∑–Ω–µ—Å–∞
    document.getElementById('search-btn').addEventListener('click', async () => {
      const query = document.getElementById('search-biz').value.trim().toLowerCase();
      
      if (!query) {
        await renderShop();
        return;
      }
      
      const list = document.getElementById('shop-list');
      list.innerHTML = '';
      
      try {
        const snaps = await db.collection('businesses').get();
        let found = false;
        
        snaps.forEach(doc => {
          const biz = doc.data();
          biz.id = doc.id;
          
          if (biz.name.toLowerCase().includes(query)) {
            found = true;
            
            const el = document.createElement('div');
            el.className = 'biz-card';
            
            const ownerText = biz.ownerUid ? 
              '<div class="muted small">–ó–∞–Ω—è—Ç</div>' : 
              `<button class="btn buy-btn" data-id="${biz.id}">–ö—É–ø–∏—Ç—å</button>`;
            
            el.innerHTML = `
              <div style="display:flex;gap:12px;align-items:center">
                <img src="${biz.icon || 'https://via.placeholder.com/64/0fb48b/ffffff?text=B'}" width="64" height="64" style="border-radius:8px;object-fit:cover" />
                <div style="flex:1">
                  <strong>${biz.name}</strong>
                  <div class="muted small">–î–æ—Ö–æ–¥/—á: ${biz.incomePerHour} ‚Ä¢ –¶–µ–Ω–∞: ${biz.price} ‚ÇΩ</div>
                </div>
                <div>${ownerText}</div>
              </div>
            `;
            
            list.appendChild(el);
          }
        });
        
        if (!found) {
          list.innerHTML = '<div class="muted">–ë–∏–∑–Ω–µ—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        } else {
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–æ–∫—É–ø–∫–∏
          document.querySelectorAll('.buy-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const id = e.currentTarget.dataset.id;
              
              if (!currentUser) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
              }
              
              const bizRef = db.collection('businesses').doc(id);
              
              try {
                await db.runTransaction(async (tx) => {
                  const bizDoc = await tx.get(bizRef);
                  
                  if (!bizDoc.exists) throw new Error('–ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                  
                  const bizData = bizDoc.data();
                  
                  if (bizData.ownerUid) throw new Error('–ë–∏–∑–Ω–µ—Å —É–∂–µ –∫—É–ø–ª–µ–Ω');
                  
                  const userRef = db.collection('users').doc(currentUser.uid);
                  const userDoc = await tx.get(userRef);
                  const userData = userDoc.data();
                  
                  if (userData.balance < bizData.price) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                  
                  tx.update(userRef, { 
                    balance: firebase.firestore.FieldValue.increment(-bizData.price) 
                  });
                  
                  tx.update(bizRef, { 
                    ownerUid: currentUser.uid, 
                    lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp() 
                  });
                });
                
                alert('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!');
                await refreshUserDoc();
                await renderShop();
                await renderMyBusinesses();
                await renderRating();
              } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
              }
            });
          });
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
        list.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
      }
    });

    // –ê–¥–º–∏–Ω: —Å–æ–∑–¥–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞
    document.getElementById('admin-create-biz').addEventListener('click', async () => {
      if (!currentUser || !isAdminUser(currentUserDoc, currentUser)) {
        alert('–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É');
        return;
      }
      
      const name = document.getElementById('admin-biz-name').value.trim();
      const price = parseInt(document.getElementById('admin-biz-price').value);
      const income = parseInt(document.getElementById('admin-biz-income').value);
      const icon = document.getElementById('admin-biz-icon').value.trim();
      
      if (!name || isNaN(price) || isNaN(income) || price <= 0 || income <= 0) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
        return;
      }
      
      try {
        await db.collection('businesses').add({
          name,
          price,
          incomePerHour: income,
          ownerUid: null,
          icon: icon || '',
          lastCollectedAt: null
        });
        
        alert('–ë–∏–∑–Ω–µ—Å —Å–æ–∑–¥–∞–Ω');
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        document.getElementById('admin-biz-name').value = '';
        document.getElementById('admin-biz-price').value = '';
        document.getElementById('admin-biz-income').value = '';
        document.getElementById('admin-biz-icon').value = '';
        
        await renderShop();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + err.message);
      }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function refreshUserDoc() {
      if (!currentUser) return;
      
      try {
        const userSnap = await db.collection('users').doc(currentUser.uid).get();
        
        if (userSnap.exists) {
          currentUserDoc = userSnap.data();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º UI
          document.getElementById('balance').innerText = String(currentUserDoc.balance || 0);
          document.getElementById('hud-balance').innerText = String(currentUserDoc.balance || 0);
          if(document.getElementById('hud-diamonds')) document.getElementById('hud-diamonds').innerText = String(currentUserDoc.diamonds || 0);
          if(document.getElementById('hud-diamonds')) document.getElementById('hud-diamonds').innerText = String(currentUserDoc.diamonds || 0);
          if(document.getElementById('display-diamonds')) document.getElementById('display-diamonds').innerText = String(currentUserDoc.diamonds || 0);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–º–æ-–±–∏–∑–Ω–µ—Å–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
    (async function ensureDemoBusinesses() {
      try {
        const bizSnap = await db.collection('businesses').limit(1).get();
        
        if (bizSnap.empty) {
          // –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–±–∏–∑–Ω–µ—Å—ã
          const demoBusinesses = [
            { name: '–ú–∞–≥–∞–∑–∏–Ω "–£ –¥–æ–º–∞"', price: 5000, incomePerHour: 50, ownerUid: null, icon: '', lastCollectedAt: null },
            { name: '–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä "–ì–∞–ª–∞–∫—Ç–∏–∫–∞"', price: 20000, incomePerHour: 300, ownerUid: null, icon: '', lastCollectedAt: null },
            { name: '–ö–∞—Ñ–µ "–ë–æ—á–∫–∞"', price: 8000, incomePerHour: 80, ownerUid: null, icon: '', lastCollectedAt: null },
            { name: '–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å', price: 15000, incomePerHour: 150, ownerUid: null, icon: '', lastCollectedAt: null },
            { name: '–°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã', price: 12000, incomePerHour: 120, ownerUid: null, icon: '', lastCollectedAt: null }
          ];
          
          for (const biz of demoBusinesses) {
            await db.collection('businesses').add(biz);
          }
          
          console.log('–î–µ–º–æ-–±–∏–∑–Ω–µ—Å—ã —Å–æ–∑–¥–∞–Ω—ã');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–µ–º–æ-–±–∏–∑–Ω–µ—Å–æ–≤:', error);
      }
    })();

    // –†–µ–Ω–¥–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞
    async function renderShop() {
      const list = document.getElementById('shop-list');
      list.innerHTML = '';
      
      try {
        const snaps = await db.collection('businesses').orderBy('name').get();
        
        if (snaps.empty) {
          list.innerHTML = '<div class="muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–∏–∑–Ω–µ—Å–æ–≤</div>';
          return;
        }
        
        snaps.forEach(doc => {
          const biz = doc.data();
          biz.id = doc.id;
          
          const el = document.createElement('div');
          el.className = 'biz-card';
          
          const ownerText = biz.ownerUid ? 
            '<div class="muted small">–ó–∞–Ω—è—Ç</div>' : 
            `<button class="btn buy-btn" data-id="${biz.id}">–ö—É–ø–∏—Ç—å</button>`;
          
          el.innerHTML = `
            <div style="display:flex;gap:12px;align-items:center">
              <img src="${biz.icon || 'https://via.placeholder.com/64/0fb48b/ffffff?text=B'}" width="64" height="64" style="border-radius:8px;object-fit:cover" />
              <div style="flex:1">
                <strong>${biz.name}</strong>
                <div class="muted small">–î–æ—Ö–æ–¥/—á: ${biz.incomePerHour} ‚Ä¢ –¶–µ–Ω–∞: ${biz.price} ‚ÇΩ</div>
              </div>
              <div>${ownerText}</div>
            </div>
          `;
          
          list.appendChild(el);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∫—É–ø–∫–∏
        document.querySelectorAll('.buy-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id;
            
            if (!currentUser) {
              alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
              return;
            }
            
            const bizRef = db.collection('businesses').doc(id);
            
            try {
              await db.runTransaction(async (tx) => {
                const bizDoc = await tx.get(bizRef);
                
                if (!bizDoc.exists) throw new Error('–ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                
                const bizData = bizDoc.data();
                
                if (bizData.ownerUid) throw new Error('–ë–∏–∑–Ω–µ—Å —É–∂–µ –∫—É–ø–ª–µ–Ω');
                
                const userRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await tx.get(userRef);
                const userData = userDoc.data();
                
                if (userData.balance < bizData.price) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                
                tx.update(userRef, { 
                  balance: firebase.firestore.FieldValue.increment(-bizData.price) 
                });
                
                tx.update(bizRef, { 
                  ownerUid: currentUser.uid, 
                  lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
              });
              
              alert('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!');
              await refreshUserDoc();
              await renderShop();
              await renderMyBusinesses();
              await renderRating();
            } catch (err) {
              alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
          });
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞:', error);
        list.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞</div>';
      }
    }


    // –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è Firestore (–ø–∏—à–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å –∏ —á–∏—Ç–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π timestamp)
    async function getServerTime() {
      try {
        const ref = db.collection('_serverTime').doc('_now');
        await ref.set({ t: firebase.firestore.FieldValue.serverTimestamp() });
        const snap = await ref.get();
        const ts = snap.get('t');
        return ts ? ts.toDate() : new Date();
      } catch (e) {
        console.error('getServerTime error', e);
        return new Date();
      }
    }

    // –†–µ–Ω–¥–µ—Ä –º–æ–∏—Ö –±–∏–∑–Ω–µ—Å–æ–≤
    async function renderMyBusinesses() {
      const list = document.getElementById('my-list');
            list.innerHTML = '';
      
      if (!currentUser) {
        list.innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ –±–∏–∑–Ω–µ—Å—ã</div>';
        return;
      }
      
      try {
        const snaps = await db.collection('businesses').where('ownerUid', '==', currentUser.uid).get();
        
        if (snaps.empty) {
          list.innerHTML = '<div class="muted">–£ –≤–∞—Å –Ω–µ—Ç –±–∏–∑–Ω–µ—Å–æ–≤</div>';
          return;
        }
        
        snaps.forEach(doc => {
          const biz = doc.data();
          biz.id = doc.id;
          
          const lastCollected = biz.lastCollectedAt ? biz.lastCollectedAt.toDate() : serverNow;
          const now = serverNow;
          const hoursPassed = (now - lastCollected) / (1000 * 60 * 60);
          const pendingIncome = Math.floor(biz.incomePerHour * hoursPassed);
          
          const el = document.createElement('div');
          el.className = 'biz-card';
          
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong>${biz.name}</strong>
                <div class="muted small">–î–æ—Ö–æ–¥/—á: ${biz.incomePerHour} ‚Ä¢ –ù–∞–∫–æ–ø–ª–µ–Ω–æ: ${pendingIncome} ‚ÇΩ</div>
              </div>
              <div class="flex">
                <button class="btn collect-btn" data-id="${biz.id}">–°–æ–±—Ä–∞—Ç—å</button>
                <button class="btn sell-gov" data-id="${biz.id}" style="background:rgba(200,60,60,0.9);margin-left:6px">–ü—Ä–æ–¥–∞—Ç—å –≥–æ—Å.</button>
                <button class="btn sell-player" data-id="${biz.id}" style="background:rgba(120,120,120,0.9);margin-left:6px">–ü—Ä–æ–¥–∞—Ç—å –∏–≥—Ä–æ–∫—É</button>
              </div>
            </div>
          `;
          
          list.appendChild(el);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–±–æ—Ä–∞ –¥–æ—Ö–æ–¥–∞
        document.querySelectorAll('.collect-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            
            if (!currentUser) {
              alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
              return;
            }
            
            const bizRef = db.collection('businesses').doc(id);
            
            try {
              await db.runTransaction(async (tx) => {
                const bizDoc = await tx.get(bizRef);
                
                if (!bizDoc.exists) throw new Error('–ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                
                const bizData = bizDoc.data();
                
                if (bizData.ownerUid !== currentUser.uid) throw new Error('–í—ã –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞');
                
                const serverNowForCollect = await getServerTime();
                const lastCollected = bizData.lastCollectedAt ? bizData.lastCollectedAt.toDate() : serverNowForCollect;
                const hoursPassed = (serverNowForCollect - lastCollected) / (1000 * 60 * 60);
                const income = Math.floor(bizData.incomePerHour * hoursPassed);
                
                if (income <= 0) throw new Error('–ù–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞');
                
                const userRef = db.collection('users').doc(currentUser.uid);
                
                tx.update(userRef, { 
                  balance: firebase.firestore.FieldValue.increment(income) 
                });
                
                tx.update(bizRef, { 
                  lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
              });
              
              alert('–î–æ—Ö–æ–¥ —Å–æ–±—Ä–∞–Ω!');
              await refreshUserDoc();
              await renderMyBusinesses();
            } catch (err) {
              alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
          });
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤—É
        document.querySelectorAll('.sell-gov').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            
            if (!confirm('–ü—Ä–æ–¥–∞—Ç—å –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤—É? –í—ã –ø–æ–ª—É—á–∏—Ç–µ 70% –æ—Ç —Ü–µ–Ω—ã.')) return;
            
            const bizRef = db.collection('businesses').doc(id);
            
            try {
              await db.runTransaction(async (tx) => {
                const bizDoc = await tx.get(bizRef);
                
                if (!bizDoc.exists) throw new Error('–ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                
                const bizData = bizDoc.data();
                
                if (bizData.ownerUid !== currentUser.uid) throw new Error('–í—ã –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞');
                
                const salePrice = Math.floor(bizData.price * 0.7);
                const userRef = db.collection('users').doc(currentUser.uid);
                
                tx.update(userRef, { 
                  balance: firebase.firestore.FieldValue.increment(salePrice) 
                });
                
                tx.update(bizRef, { 
                  ownerUid: null, 
                  lastCollectedAt: null 
                });
              });
              
              alert('–ë–∏–∑–Ω–µ—Å –ø—Ä–æ–¥–∞–Ω –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤—É!');
              await refreshUserDoc();
              await renderShop();
              await renderMyBusinesses();
              await renderRating();
            } catch (err) {
              alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
          });
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂–∏ –∏–≥—Ä–æ–∫—É
        document.querySelectorAll('.sell-player').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id;
            currentSellBizId = id;
            
            const bizRef = db.collection('businesses').doc(id);
            const bizDoc = await bizRef.get();
            
            if (!bizDoc.exists) {
              alert('–ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
              return;
            }
            
            const bizData = bizDoc.data();
            const minPrice = Math.floor(bizData.price * 0.5);
            const maxPrice = Math.floor(bizData.price * 2);
            
            document.getElementById('sell-price').placeholder = `–¶–µ–Ω–∞ –æ—Ç ${minPrice} –¥–æ ${maxPrice}`;
            document.getElementById('sell-modal').classList.remove('hidden');
          });
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–∑–Ω–µ—Å–æ–≤:', error);
        list.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–∑–Ω–µ—Å–æ–≤</div>';
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –≤–∫–ª–∞–¥–æ–∫
    function setupAdminTabs() {
      const tabs = document.querySelectorAll('.admin-tab');
      const tabContents = document.querySelectorAll('.admin-tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          
          // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(content => content.classList.add('hidden'));
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
          tab.classList.add('active');
          document.getElementById(`admin-${tabId}`).classList.remove('hidden');
        });
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–∑–∏–Ω–æ
	function initCasino() {
	  const canvas = document.getElementById('roulette-canvas');
	  if (!canvas) return;
	  
	  const ctx = canvas.getContext('2d');
  const __wheelStyle = getComputedStyle(document.documentElement);
  const __wheelColor1 = __wheelStyle.getPropertyValue('--wheel-bg1').trim() || 'rgba(255,255,255,0.03)';
  const __wheelColor2 = __wheelStyle.getPropertyValue('--wheel-bg2').trim() || 'rgba(255,255,255,0.02)';
  // text color for wheel sectors
  const __wheelText = __wheelStyle.getPropertyValue('--wheel-text').trim() || getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || 'white';
	  const wheelEl = document.getElementById('roulette-wheel');
	  const resultEl = document.getElementById('casino-result');
	  const spinBtn = document.getElementById('spin-btn');
	  const costInput = document.getElementById('spin-cost');

	  const sectors = [
		{label:'0x', mult:0},
		{label:'0.5x', mult:0.5},
		{label:'1x', mult:1},
		{label:'1x', mult:1},
		{label:'2x', mult:2},
		{label:'0x', mult:0},
		{label:'0.5x', mult:0.5},
		{label:'1x', mult:1},
		{label:'3x', mult:3},
		{label:'1x', mult:1},
		{label:'0x', mult:0},
		{label:'2x', mult:2}
	  ];
	  const sectorCount = sectors.length;

	  function drawWheel(){
		const w = canvas.width;
		const h = canvas.height;
		const cx = w/2; const cy = h/2; const r = Math.min(cx,cy)-10;
		ctx.clearRect(0,0,w,h);
		const angleStep = (Math.PI*2)/sectorCount;
		for(let i=0;i<sectorCount;i++){
		  const start = -Math.PI/2 + i*angleStep;
		  const end = start + angleStep;
		  ctx.beginPath();
		  ctx.moveTo(cx,cy);
		  ctx.arc(cx,cy,r,start,end,false);
		  ctx.closePath();
		  ctx.fillStyle = (i%2===0) ? __wheelColor1 : __wheelColor2;
		  ctx.fill();
		  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
		  ctx.stroke();
		  ctx.save();
		  ctx.translate(cx,cy);
		  const ang = start + angleStep/2;
		  ctx.rotate(ang);
		  ctx.textAlign = 'right';
		  ctx.fillStyle = __wheelText;
		  ctx.font = '24px Inter, Arial';
		  ctx.fillText(sectors[i].label, r-20, 10);
		  ctx.restore();
		}
		ctx.beginPath(); 
		ctx.arc(cx,cy,48,0,Math.PI*2); 
		ctx.fillStyle='rgba(0,0,0,0.4)'; 
		ctx.fill();
		ctx.fillStyle=__wheelText; 
		ctx.font='20px Inter, Arial'; 
		ctx.textAlign='center'; 
		ctx.fillText('–†–£–õ–ï–¢–ö–ê',cx,cy+6);
	  }

	  function chooseSectorBiased(){
		const rand = Math.random();
		if(rand < 0.30){
		  const zeros = sectors.map((s,i)=> s.mult===0?i:-1).filter(i=>i>=0);
		  return zeros[Math.floor(Math.random()*zeros.length)];
		} else if(rand < 0.50){
		  const halfs = sectors.map((s,i)=> s.mult===0.5?i:-1).filter(i=>i>=0);
		  return halfs[Math.floor(Math.random()*halfs.length)];
		} else if(rand < 0.75){
		  const ones = sectors.map((s,i)=> s.mult===1?i:-1).filter(i=>i>=0);
		  return ones[Math.floor(Math.random()*ones.length)];
		} else if(rand < 0.90){
		  const twos = sectors.map((s,i)=> s.mult===2?i:-1).filter(i=>i>=0);
		  return twos[Math.floor(Math.random()*twos.length)];
		} else {
		  const threes = sectors.map((s,i)=> s.mult===3?i:-1).filter(i=>i>=0);
		  return threes[Math.floor(Math.random()*threes.length)];
		}
	  }

	  async function doSpin(isDemo=false){
		if(spinning) return;
		if(!currentUser){ alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É'); return; }
		
		// –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
		if(!currentUserDoc){ 
		  await refreshUserDoc(); 
		}
		
		let cost = parseInt(costInput.value) || 0;
		if(cost < 1000) { cost = 1000; costInput.value = cost; }
		if(cost > 50000) { cost = 50000; costInput.value = cost; }

		if(!isDemo){
		  if((currentUserDoc?.balance || 0) < cost){ 
			alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); 
			return; 
		  }
		}

		spinning = true;
		spinBtn.disabled = true;
		resultEl.innerText = '–ö—Ä—É—Ç–∏–º...';

		if(!isDemo){
		  try{ 
			await db.collection('users').doc(currentUser.uid).update({ 
			  balance: firebase.firestore.FieldValue.increment(-cost),
			  'questProgress.casinoSpins': firebase.firestore.FieldValue.increment(1)
			}); 
			await refreshUserDoc();
}
		  catch(e){ 
			console.error('–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Å—Ç–∞–≤–∫–∏',e); 
			spinning = false;
			spinBtn.disabled = false;
			return;
		  }
		}

		const chosenIndex = chooseSectorBiased();
		const sectorAngle = 360 / sectorCount;
		const randomSpins = 4 + Math.floor(Math.random()*3);
		const offset = sectorAngle * chosenIndex + sectorAngle/2;
		const targetDeg = randomSpins*360 + (360 - offset);

		// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–∞—â–µ–Ω–∏–µ
		wheelEl.style.transition = 'none';
		wheelEl.style.transform = 'rotate(0deg)';
		
		// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
		setTimeout(() => {
		  wheelEl.style.transition = 'transform 5s cubic-bezier(0.22, 0.61, 0.36, 1)';
		  wheelEl.style.transform = `rotate(${targetDeg}deg)`;
		}, 50);

		wheelEl.addEventListener('transitionend', async function handler(){
		  wheelEl.removeEventListener('transitionend', handler);
		  
		  const sector = sectors[chosenIndex];
		  const mult = sector.mult;
		  let payout = 0;
		  
		  if(mult > 0){
			payout = Math.floor(cost * mult);
			if(!isDemo){
			  try{ 
				await db.collection('users').doc(currentUser.uid).update({ 
				  balance: firebase.firestore.FieldValue.increment(payout) 
				}); 
			  } 
			  catch(e){ 
				console.error('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –≤—ã–∏–≥—Ä—ã—à–∞',e); 
			  }
			}
		  }

		  await refreshUserDoc();
		  resultEl.innerHTML = `–†–µ–∑—É–ª—å—Ç–∞—Ç: <strong>${sector.label}</strong> ‚Äî –º–Ω–æ–∂–∏—Ç–µ–ª—å ${mult}x. ${payout>0?('–í—ã–∏–≥—Ä—ã—à: '+payout+' ‚ÇΩ'):'–ü—Ä–æ–∏–≥—Ä—ã—à'} `;

		  spinning = false;
		  spinBtn.disabled = false;
		}, {once: true});
	  }

	  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
	  const newSpinBtn = spinBtn.cloneNode(true);
	  spinBtn.parentNode.replaceChild(newSpinBtn, spinBtn);
	  
	  document.getElementById('spin-btn').addEventListener('click', () => doSpin(false));

	  // –†–∏—Å—É–µ–º –∫–æ–ª–µ—Å–æ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
	  drawWheel();
	}

    // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –≤–∫–ª–∞–¥–æ–∫
    setupAdminTabs();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
      console.log('GSK LAND loaded successfully');
      
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–µ—Å–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
      window.addEventListener('resize', function() {
        if (!views.casino.classList.contains('hidden')) {
          setTimeout(initCasino, 100);
        }
      });
    });
  </script>

<button class="theme-toggle" id="theme-toggle">üåô/‚òÄÔ∏è</button>
<script>
  const themeToggle = document.getElementById('theme-toggle');
  const root = document.documentElement;
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if(localStorage.getItem('theme')) {
    root.setAttribute('data-theme', localStorage.getItem('theme'));
  }
  themeToggle.addEventListener('click', () => {
    if(root.getAttribute('data-theme') === 'light') {
      root.removeAttribute('data-theme');
      localStorage.setItem('theme', 'dark');
    } else {
      root.setAttribute('data-theme','light');
      localStorage.setItem('theme','light');
    }
  });
</script>


<!-- BEGIN AUGMENTATION: Education, My Company, Business Categories -->
<script>
(async function(){
  // Safety checks
  if (typeof db === 'undefined') return;
  console.log('Loading augmentation for Education, Company, Categories');

  // Education data
  const EDUCATION_LEVELS = [
    {level:1, key:'school', title:'–®–∫–æ–ª–∞', price:50000},
    {level:2, key:'college', title:'–ö–æ–ª–ª–µ–¥–∂', price:150000},
    {level:3, key:'bachelor', title:'–ë–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç', price:500000},
    {level:4, key:'master', title:'–ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞', price:800000},
    {level:5, key:'phd_candidate', title:'–ê—Å–ø–∏—Ä–∞–Ω—Ç—É—Ä–∞', price:1700000},
    {level:6, key:'doctor', title:'–î–æ–∫—Ç–æ—Ä–∞–Ω—Ç—É—Ä–∞', price:4000000}
  ];

  const COMPANY_LEVELS = [
    {key:'self', title:'–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π', price:300000},
    {key:'ip', title:'–ò–ü', price:3000000},
    {key:'ooo', title:'–û–û–û', price:10000000}
  ];

  const BIZ_CATEGORIES = ['–ú–∞–ª–µ–Ω—å–∫–∏–π','–°—Ä–µ–¥–Ω–∏–π','–ö—Ä—É–ø–Ω—ã–π'];

  // Add nav buttons
  const nav = document.getElementById('nav');
  if (nav && !document.querySelector('[data-view="education"]')) {
    const btnEdu = document.createElement('button');
    btnEdu.className='nav-btn';
    btnEdu.dataset.view='education';
    btnEdu.innerText = '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ';
    nav.insertBefore(btnEdu, document.querySelector('[data-view="help"]'));
    const btnCompany = document.createElement('button');
    btnCompany.className='nav-btn';
    btnCompany.dataset.view='company';
    btnCompany.innerText = '–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è';
    nav.insertBefore(btnCompany, document.querySelector('[data-view="help"]'));
    // Rebind nav click handlers (existing code binds initially; rebind to include new buttons)
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.removeEventListener('click', btn._augClick);
      btn._augClick = () => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const view = btn.dataset.view;
        // hide all known views
        const views = document.querySelectorAll('section');
        views.forEach(v => v.classList.add('hidden'));
        const target = document.getElementById('view-' + view);
        if (target) target.classList.remove('hidden');
        // call renderers
        if (view === 'education') renderEducation();
        if (view === 'company') renderMyCompany();
        if (view === 'rating') if (typeof renderRating === 'function') renderRating();
        if (view === 'clicker') if (typeof renderClicker === 'function') renderClicker();
        if (view === 'quests') if (typeof renderQuests === 'function') renderQuests();
        if (view === 'achievements') if (typeof renderAchievements === 'function') renderAchievements();
        if (view === 'promocodes') if (typeof renderPromocodes === 'function') renderPromocodes();
        if (view === 'news') if (typeof renderNews === 'function') renderNews();
        if (view === 'casino') if (typeof initCasino === 'function') initCasino();
        if (view === 'admin' && isAdminUser && isAdminUser(currentUserDoc, currentUser)) {
          if (typeof renderAdminUsers === 'function') renderAdminUsers();
        }
      };
      btn.addEventListener('click', btn._augClick);
    });
  }

  // Create views if missing
  const main = document.getElementById('main');
  function ensureView(id, title, innerHTML){
    if (!document.getElementById('view-'+id)) {
      const section = document.createElement('section');
      section.className='hidden';
      section.id = 'view-'+id;
      section.innerHTML = `<h2>${title}</h2>` + (innerHTML || '');
      main.appendChild(section);
    }
  }

  ensureView('education','–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',`
    <div class="card">
      <div id="education-area"></div>
    </div>
  `);

  ensureView('company','–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è',`
    <div class="card">
      <div id="company-area"></div>
    </div>
  `);

  // RENDERERS
  async function refreshUserLocal(){
    if (!currentUser) return;
    const ref = db.collection('users').doc(currentUser.uid);
    const snap = await ref.get();
    currentUserDoc = snap.exists ? snap.data() : currentUserDoc;
    // update HUD balance
    if (document.getElementById('hud-balance')) document.getElementById('hud-balance').innerText = String(currentUserDoc.balance || 0);
  }

  window.renderEducation = async function renderEducation(){
    const area = document.getElementById('education-area');
    if (!area) return;
    if (!currentUser) {
      area.innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º</div>';
      return;
    }
    await refreshUserLocal();
    const userLevel = currentUserDoc.educationLevel || 0;
    area.innerHTML = '';
    EDUCATION_LEVELS.forEach(l => {
      const completed = userLevel >= l.level;
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `<strong>${l.level} —É—Ä–æ–≤–µ–Ω—å ‚Äî ${l.title}</strong> <div class="muted small">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${l.price.toLocaleString()} ‚ÇΩ</div>
        <div style="margin-top:8px">${completed ? '<div class="btn" style="background:rgba(15,180,139,0.9)">–û–∫–æ–Ω—á–µ–Ω–æ</div>' : (userLevel === l.level-1 ? '<button class="btn upgrade-edu" data-level="'+l.level+'">–û–ø–ª–∞—Ç–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å</button>' : '<div class="muted">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É—Ä–æ–≤–Ω–∏</div>')}</div>`;
      area.appendChild(el);
    });
    // attach listeners
    area.querySelectorAll('.upgrade-edu').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const level = parseInt(e.target.dataset.level);
        const lvlObj = EDUCATION_LEVELS.find(x=>x.level===level);
        if (!lvlObj) return;
        if (!confirm('–ö—É–ø–∏—Ç—å ' + lvlObj.title + ' –∑–∞ ' + lvlObj.price.toLocaleString() + ' ‚ÇΩ?')) return;
        try {
          const userRef = db.collection('users').doc(currentUser.uid);
          await db.runTransaction(async tx => {
            const ud = (await tx.get(userRef)).data();
            if (!ud) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            const cur = ud.educationLevel || 0;
            if (cur !== level-1) throw new Error('–ù–µ–ª—å–∑—è –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —É—Ä–æ–≤–Ω–∏. –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: '+cur);
            if ((ud.balance||0) < lvlObj.price) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
            tx.update(userRef, {
              balance: firebase.firestore.FieldValue.increment(-lvlObj.price),
              educationLevel: level,
              educationAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });
          alert('–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ' + lvlObj.title);
          await refreshUserLocal();
          renderEducation();
        } catch (err) {
          alert('–û—à–∏–±–∫–∞: ' + (err.message||err));
        }
      });
    });
  };

  // My Company
  window.renderMyCompany = async function renderMyCompany(){
    const area = document.getElementById('company-area');
    if (!area) return;
    if (!currentUser) {
      area.innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</div>';
      return;
    }
    await refreshUserLocal();
    const comp = currentUserDoc.company || null;
    area.innerHTML = '';
    if (comp && comp.name) {
      // show company card and management actions
      area.innerHTML = `
        <div class="card">
          <strong>–í–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è: ${comp.name}</strong>
          <div class="muted small">–§–æ—Ä–º–∞: ${comp.levelTitle || comp.level}</div>
          <div class="muted small">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${comp.category || '‚Äî'}</div>
          <div style="margin-top:8px" class="flex">
            <button class="btn rename-company">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
            <button class="btn" id="company-close" style="background:rgba(200,60,60,0.9)">–ó–∞–∫—Ä—ã—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</button>
          </div>
        </div>
      `;
      area.querySelector('.rename-company').addEventListener('click', async () => {
        const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏', comp.name);
        if (!newName) return;
        try {
          await db.collection('users').doc(currentUser.uid).update({'company.name': newName});
          alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ');
          await refreshUserLocal();
          renderMyCompany();
        } catch (e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
      });
      area.querySelector('#company-close').addEventListener('click', async () => {
        if (!confirm('–ó–∞–∫—Ä—ã—Ç—å –∫–æ–º–ø–∞–Ω–∏—é?')) return;
        try {
          await db.collection('users').doc(currentUser.uid).update({company: firebase.firestore.FieldValue.delete()});
          alert('–ö–æ–º–ø–∞–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∞');
          await refreshUserLocal();
          renderMyCompany();
        } catch (e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
      });
    } else {
      // show form to create company
      const minLevelInfo = COMPANY_LEVELS.map(c=>{
        return `<option value="${c.key}" data-price="${c.price}">${c.title} ‚Äî ${c.price.toLocaleString()} ‚ÇΩ</option>`;
      }).join('');
      area.innerHTML = `
        <div class="card">
          <h3>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</h3>
          <input id="company-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏"/>
          <select id="company-level-select" style="margin-top:8px">${minLevelInfo}</select>
          <div class="muted small" style="margin-top:6px">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é: –°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π ‚Äî –æ–∫–æ–Ω—á–∞–Ω–∏–µ –®–∫–æ–ª—ã; –ò–ü ‚Äî –æ–∫–æ–Ω—á–∞–Ω–∏–µ –ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—ã; –û–û–û ‚Äî –æ–∫–æ–Ω—á–∞–Ω–∏–µ –ê—Å–ø–∏—Ä–∞–Ω—Ç—É—Ä—ã</div>
          <div style="margin-top:8px"><button class="btn" id="create-company-btn">–°–æ–∑–¥–∞—Ç—å</button></div>
        </div>
      `;
      document.getElementById('create-company-btn').addEventListener('click', async () => {
        const name = document.getElementById('company-name-input').value.trim();
        const lvlKey = document.getElementById('company-level-select').value;
        if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏'); return; }
        const lvlObj = COMPANY_LEVELS.find(x=>x.key===lvlKey);
        if (!lvlObj) return;
        // check education prereq
        const ed = currentUserDoc.educationLevel || 0;
        const mapping = { 'self':1, 'ip':4, 'ooo':5 }; // required education levels
        const required = mapping[lvlKey];
        if (ed < required) {
          alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è. –¢—Ä–µ–±—É–µ—Ç—Å—è: ' + EDUCATION_LEVELS.find(x=>x.level===required).title);
          return;
        }
        if ((currentUserDoc.balance||0) < lvlObj.price) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
        try {
          await db.runTransaction(async tx => {
            const uRef = db.collection('users').doc(currentUser.uid);
            const uDoc = await tx.get(uRef);
            if (!uDoc.exists) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            const u = uDoc.data();
            if ((u.balance||0) < lvlObj.price) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
            // set company object
            tx.update(uRef, {
              balance: firebase.firestore.FieldValue.increment(-lvlObj.price),
              company: {
                name: name,
                level: lvlObj.key,
                levelTitle: lvlObj.title,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              }
            });
          });
          alert('–ö–æ–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
          await refreshUserLocal();
          renderMyCompany();
        } catch (err) {
          alert('–û—à–∏–±–∫–∞: ' + (err.message||err));
        }
      });
    }
  };

  // Admin: extend create business form to include category select, and create listener that creates business with category
  function enhanceAdminCreateBiz(){
    const adminBizCard = document.querySelector('#admin-businesses .card');
    if (!adminBizCard) return;
    if (!document.getElementById('admin-biz-category')) {
      const sel = document.createElement('select');
      sel.id = 'admin-biz-category';
      sel.style.marginTop = '8px';
      sel.innerHTML = `<option value="">(–∞–≤—Ç–æ) –ö—Ä—É–ø–Ω—ã–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>` + BIZ_CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join('');
      const iconInput = document.getElementById('admin-biz-icon');
      iconInput.insertAdjacentElement('afterend', sel);
    }
    // create handler
    document.getElementById('admin-create-biz').addEventListener('click', async () => {
      if (!currentUser || !isAdminUser(currentUserDoc, currentUser)) { alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω'); return; }
      const name = document.getElementById('admin-biz-name').value.trim();
      const price = parseInt(document.getElementById('admin-biz-price').value);
      const income = parseInt(document.getElementById('admin-biz-income').value);
      const icon = document.getElementById('admin-biz-icon').value.trim();
      const category = document.getElementById('admin-biz-category').value || '–ö—Ä—É–ø–Ω—ã–π';
      if (!name || isNaN(price) || isNaN(income)) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è'); return; }
      try {
        await db.collection('businesses').add({
          name: name,
          price: price,
          incomePerHour: income,
          icon: icon || '',
          category: category,
          ownerUid: null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('–ë–∏–∑–Ω–µ—Å —Å–æ–∑–¥–∞–Ω');
        document.getElementById('admin-biz-name').value=''; document.getElementById('admin-biz-price').value=''; document.getElementById('admin-biz-income').value=''; document.getElementById('admin-biz-icon').value='';
        if (typeof renderShop === 'function') renderShop();
      } catch (e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
    });
  }

  // Helper to ensure businesses without category are set to '–ö—Ä—É–ø–Ω—ã–π' when rendered or in DB
  async function ensureBizCategories(){
    try {
      const snaps = await db.collection('businesses').where('category','==', '').get();
      snaps.forEach(doc => {
        doc.ref.update({category: '–ö—Ä—É–ø–Ω—ã–π'});
      });
      // also fix docs missing category by scanning small batch
      const allSnaps = await db.collection('businesses').get();
      allSnaps.forEach(doc => {
        const d = doc.data();
        if (!d.category) doc.ref.update({category: '–ö—Ä—É–ø–Ω—ã–π'});
      });
    } catch (e) { console.warn('ensureBizCategories error', e); }
  }

  // Augmented renderShop and renderMyBusinesses that include category in cards
  window.renderShop = async function renderShopAugmented(){
    const el = document.getElementById('shop-list');
    if (!el) return;
    el.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      await ensureBizCategories();
      const snaps = await db.collection('businesses').get();
      el.innerHTML = '';
      snaps.forEach(doc => {
        const b = doc.data();
        const card = document.createElement('div');
        card.className='biz-card';
        const owner = b.ownerUid ? '<div class="muted small">–í–ª–∞–¥–µ–ª–µ—Ü: –∑–∞–Ω—è—Ç</div>' : '<div class="muted small">–í–ª–∞–¥–µ–ª–µ—Ü: —Å–≤–æ–±–æ–¥–µ–Ω</div>';
        const category = b.category || '–ö—Ä—É–ø–Ω—ã–π';
        card.innerHTML = `<strong>${b.name}</strong>
          <div class="muted small">–¶–µ–Ω–∞: ${b.price?.toLocaleString?.()||b.price} ‚ÇΩ ‚Ä¢ –î–æ—Ö–æ–¥/—á: ${b.incomePerHour || 0} ‚ÇΩ</div>
          <div class="muted small">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}</div>
          ${owner}
          <div style="margin-top:8px" class="flex">
            ${b.ownerUid ? '' : `<button class="btn buy-biz" data-id="${doc.id}">–ö—É–ø–∏—Ç—å</button>`}
          </div>`;
        el.appendChild(card);
      });
      // Attach buy handlers (keep existing logic if exists)
      document.querySelectorAll('.buy-biz').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          if (!currentUser) { alert('–í–æ–π–¥–∏—Ç–µ'); return; }
          const id = e.target.dataset.id;
          try {
            await db.runTransaction(async tx=>{
              const bRef = db.collection('businesses').doc(id);
              const bDoc = await tx.get(bRef);
              if (!bDoc.exists) throw new Error('–ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
              const bData = bDoc.data();
              if (bData.ownerUid) throw new Error('–£–∂–µ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω');
              const price = bData.price || 0;
              const uRef = db.collection('users').doc(currentUser.uid);
              const uDoc = await tx.get(uRef);
              const u = uDoc.data();
              if ((u.balance||0) < price) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
              tx.update(uRef, { balance: firebase.firestore.FieldValue.increment(-price) });
              tx.update(bRef, { ownerUid: currentUser.uid, lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp() });
            });
            alert('–ë–∏–∑–Ω–µ—Å —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω');
            await refreshUserLocal();
            if (typeof renderShop === 'function') renderShop();
            if (typeof renderMyBusinesses === 'function') renderMyBusinesses();
          } catch (err) {
            alert('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏: '+(err.message||err));
          }
        });
      });
    } catch (e) {
      el.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      console.error(e);
    }
  };

  window.renderMyBusinesses = async function renderMyBusinessesAugmented(){
    const list = document.getElementById('my-list');
    list.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    if (!currentUser) { list.innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ</div>'; return; }
    try {
      const snaps = await db.collection('businesses').where('ownerUid','==', currentUser.uid).get();
      list.innerHTML = '';
      if (snaps.empty) { list.innerHTML = '<div class="muted">–£ –≤–∞—Å –Ω–µ—Ç –±–∏–∑–Ω–µ—Å–æ–≤</div>'; return; }
      snaps.forEach(doc=>{
        const b = doc.data();
        const pendingIncome = 0; // keep simple, original calculate when rendering (server time needed)
        const el = document.createElement('div');
        el.className='card';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>${b.name}</strong>
              <div class="muted small">–¶–µ–Ω–∞: ${b.price?.toLocaleString?.()||b.price} ‚ÇΩ ‚Ä¢ –î–æ—Ö–æ–¥/—á: ${b.incomePerHour || 0} ‚ÇΩ</div>
              <div class="muted small">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${b.category || '–ö—Ä—É–ø–Ω—ã–π'}</div>
            </div>
            <div style="text-align:right">
              <div class="muted small">–ù–∞–∫–æ–ø–ª–µ–Ω–æ: ${pendingIncome} ‚ÇΩ</div>
              <div class="flex" style="margin-top:8px">
                <button class="btn collect-btn" data-id="${doc.id}">–°–æ–±—Ä–∞—Ç—å</button>
                <button class="btn sell-gov" data-id="${doc.id}" style="background:rgba(200,60,60,0.9);margin-left:6px">–ü—Ä–æ–¥–∞—Ç—å –≥–æ—Å.</button>
                <button class="btn sell-player" data-id="${doc.id}" style="background:rgba(120,120,120,0.9);margin-left:6px">–ü—Ä–æ–¥–∞—Ç—å –∏–≥—Ä–æ–∫—É</button>
              </div>
            </div>
          </div>
        `;
        list.appendChild(el);
      });
      // reattach handlers similar to original
      document.querySelectorAll('.sell-player').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          currentSellBizId = e.target.dataset.id;
          document.getElementById('sell-modal').classList.remove('hidden');
        });
      });
      // collect and sell-gov handlers are present in the original file; we don't override them here.
    } catch (e) {
      list.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      console.error(e);
    }
  };

  // Ensure new deals include bizCategory: listen for new deals and patch
  db.collection('deals').onSnapshot(async snap=>{
    snap.docChanges().forEach(async change=>{
      if (change.type === 'added') {
        const d = change.doc.data();
        if (!d.bizCategory && d.bizId) {
          try {
            const bDoc = await db.collection('businesses').doc(d.bizId).get();
            const cat = bDoc.exists ? (bDoc.data().category || '–ö—Ä—É–ø–Ω—ã–π') : '–ö—Ä—É–ø–Ω—ã–π';
            await change.doc.ref.update({ bizCategory: cat });
            console.log('Patched deal bizCategory', change.doc.id, cat);
          } catch (e) { console.warn('deal patch error', e); }
        }
      }
    });
  });

  // call enhancements on load
  document.addEventListener('DOMContentLoaded', () => {
    enhanceAdminCreateBiz();
    // expose functions to global scope if needed
    window.renderEducation = window.renderEducation;
    window.renderMyCompany = window.renderMyCompany;
    // replace existing renderShop/renderMyBusinesses if present
    try { if (typeof renderShop === 'function') window._orig_renderShop = renderShop; } catch(e){}
    try { if (typeof renderMyBusinesses === 'function') window._orig_renderMyBusinesses = renderMyBusinesses; } catch(e){}
    // override
    window.renderShop = window.renderShop;
    window.renderMyBusinesses = window.renderMyBusinesses;
  });

  // Also call when auth changes
  if (typeof auth !== 'undefined') {
    auth.onAuthStateChanged((u)=>{
      setTimeout(() => {
        try { if (document.querySelector('[data-view="shop"].active')) renderShop(); } catch(e){}
      }, 500);
    });
  }

})();
</script>
<!-- END AUGMENTATION -->

</body>
</html>