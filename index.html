<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GSK LAND — бизнес-игра</title>
  <meta name="description" content="GSK LAND — бизнес-игра. Магазин, мои бизнесы, рейтинг, админ-панель." />
  <style>
    /* Emerald - dark liquid glass theme */
    :root{
      --bg:#071018;
      --panel: rgba(255,255,255,0.03);
      --panel-2: rgba(255,255,255,0.02);
      --glass-border: rgba(255,255,255,0.04);
      --accent-start:#0fb48b; /* emerald */
      --accent-end:#1aa6d9; /* cyan */
      --card-radius:18px;
      --muted:#9fb3bf;
      --text:#e8f6f4;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;background: radial-gradient(800px 400px at 10% 10%, rgba(26,166,217,0.06), transparent), radial-gradient(1000px 500px at 90% 80%, rgba(15,180,139,0.06), transparent), var(--bg); color:var(--text)}
    .app{max-width:1100px;margin:64px auto;padding:28px;backdrop-filter: blur(10px) saturate(120%); background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border-radius:24px; border:1px solid var(--glass-border); box-shadow: 0 12px 40px rgba(2,6,23,0.7);}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:22px;letter-spacing:0.4px}
    nav{display:flex;gap:8px}
    .nav-btn{padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--glass-border);cursor:pointer;color:var(--text)}
    .nav-btn.active{box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25);}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    .col{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03)); padding:18px;border-radius:var(--card-radius); border:1px solid var(--glass-border)}
    .card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid var(--glass-border);margin-bottom:12px}
    .shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .biz-card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));border:1px solid var(--glass-border)}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white;text-decoration:none;border:none;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    input,select,textarea{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;width:100%;box-sizing:border-box}
    .small{font-size:13px}
    .flex{display:flex;gap:8px;align-items:center}
    .right{justify-content:flex-end}
    .hidden{display:none}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    #hud{position:fixed;top:12px;left:50%;transform:translateX(-50%);height:56px;backdrop-filter:blur(10px);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:8px 16px;border:1px solid var(--glass-border);display:flex;align-items:center;gap:16px;z-index:1000;min-width:320px}
    .news-item{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
  </style>
</head>
<body>
  <div id="hud" class="hidden">
    <div style="display:flex;gap:10px;align-items:center"><strong id="hud-username"></strong><span class="muted" id="hud-email"></span></div>
    <div style="margin-left:auto">Баланс: <strong id="hud-balance">0</strong> ₽</div>
  </div>

  <div class="app" id="app">
    <header>
      <div>
        <h1>GSK LAND — бизнес-игра</h1>
        <div class="muted small">Играй в своём городе • Emerald liquid glass</div>
      </div>
      <nav id="nav">
        <button class="nav-btn active" data-view="home">Главная</button>
        <button class="nav-btn" data-view="shop">Магазин</button>
        <button class="nav-btn" data-view="my">Мои бизнесы</button>
        <button class="nav-btn" data-view="rating">Рейтинг</button>
        <button class="nav-btn" data-view="news">Новости</button>
        <button class="nav-btn hidden" id="nav-admin" data-view="admin">Админ</button>
      </nav>
    </header>

    <div class="grid">
      <main class="col" id="main">
        <section id="view-home">
          <div class="card">
            <h2>Добро пожаловать в GSK LAND</h2>
            <p class="muted">Покупай реальные бизнесы в городе, собирай доход, продавай и поднимайся в рейтинге. Каждый бизнес уникален и может принадлежать только одному игроку.</p>
          </div>

          <div class="card" id="auth-area">
            <div id="user-info" class="hidden">
              <div class="flex" style="justify-content:space-between">
                <div>
                  <strong id="display-name"></strong>
                  <div class="muted small" id="display-email"></div>
                </div>
                <div class="flex">
                  <div class="muted small">Баланс:</div>
                  <div style="min-width:90px;text-align:right"><strong id="balance">0</strong> ₽</div>
                </div>
              </div>
              <div style="margin-top:10px" class="flex">
                <button class="btn" id="btn-logout">Выйти</button>
                <button class="btn" id="btn-profile">Профиль</button>
              </div>
            </div>

            <div id="auth-forms">
              <div style="display:flex;gap:12px;align-items:center">
                <div style="flex:1">
                  <h3>Вход</h3>
                  <input id="login-email" placeholder="Email" />
                  <input id="login-pass" placeholder="Пароль" type="password" style="margin-top:8px" />
                  <div style="margin-top:8px"><button class="btn" id="btn-login">Войти</button></div>
                </div>
                <div style="width:1px;background:rgba(255,255,255,0.02);height:160px"></div>
                <div style="flex:1">
                  <h3>Регистрация</h3>
                  <input id="reg-username" placeholder="Никнейм" />
                  <input id="reg-email" placeholder="Email" style="margin-top:8px" />
                  <input id="reg-pass" placeholder="Пароль" type="password" style="margin-top:8px" />
                  <input id="reg-pass2" placeholder="Подтвердите пароль" type="password" style="margin-top:8px" />
                  <input id="reg-codeword" placeholder="Кодовое слово" style="margin-top:8px" />
                  <div style="margin-top:8px" class="flex"><button class="btn" id="btn-register">Зарегистрироваться</button></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Как играть</h3>
            <ol class="muted small">
              <li>Зарегистрируйся и создай никнейм.</li>
              <li>Открой Магазин и купи свободный бизнес (каждый бизнес может принадлежать только одному игроку).</li>
              <li>Заходи в раздел «Мои бизнесы» и собирай доход — кнопка "Собрать" начислит доход с последнего сбора.</li>
              <li>Можно продать бизнес государству (-30% от цены) или предложить игроку (цена от 50% до 200% от изначальной).</li>
              <li>Следи за балансом в HUD в верхней части экрана.</li>
            </ol>
          </div>
        </section>

        <section id="view-shop" class="hidden">
          <h2>Магазин бизнесов</h2>
          <div id="shop-list" class="shop-grid" style="margin-top:12px"></div>
        </section>

        <section id="view-my" class="hidden">
          <h2>Мои бизнесы</h2>
          <div class="card">
            <div class="flex" style="justify-content:space-between;align-items:center">
              <div>Список ваших бизнесов. Нажмите "Собрать" чтобы получить накопленный доход.</div>
              <div><button class="btn" id="collect-all">Собрать со всех</button></div>
            </div>
          </div>
          <div id="my-list" style="margin-top:12px"></div>
        </section>

        <section id="view-rating" class="hidden">
          <h2>Рейтинг игроков</h2>
          <div id="rating-list" style="margin-top:12px"></div>
        </section>

        <section id="view-news" class="hidden">
          <h2>Новости</h2>
          <div id="news-list" style="margin-top:12px"></div>
          <div id="news-admin" class="hidden" style="margin-top:20px">
            <h3>Добавить новость</h3>
            <input id="news-title" placeholder="Заголовок" />
            <textarea id="news-content" placeholder="Текст" style="margin-top:8px"></textarea>
            <div style="margin-top:8px"><button class="btn" id="news-add">Опубликовать</button></div>
          </div>
        </section>

        <section id="view-admin" class="hidden">
          <h2>Админ панель</h2>
          <div class="card">
            <div class="flex" style="align-items:flex-start">
              <div style="flex:1">
                <h4>Создать бизнес</h4>
                <input id="admin-biz-name" placeholder="Название" />
                <input id="admin-biz-price" placeholder="Цена" style="margin-top:8px" type="number" />
                <input id="admin-biz-income" placeholder="Доход в час" style="margin-top:8px" type="number" />
                <input id="admin-biz-icon" placeholder="URL иконки (опционально)" style="margin-top:8px" />
                <div style="margin-top:8px"><button class="btn" id="admin-create-biz">Создать</button></div>
              </div>
              <div style="width:1px;background:rgba(255,255,255,0.02);height:180px"></div>
              <div style="width:320px">
                <h4>Поиск игрока</h4>
                <input id="admin-find-user" placeholder="Никнейм или email" />
                <div style="margin-top:8px"><button class="btn" id="admin-find-btn">Найти</button></div>
                <div id="admin-find-result" style="margin-top:8px"></div>
              </div>
            </div>
          </div>
          <div id="admin-tables" style="margin-top:12px"></div>
        </section>

      </main>

      <aside class="col">
        <div class="card">
          <h3>Уведомления</h3>
          <div id="notifications"></div>
        </div>

        <div class="card">
          <h3>Поиск бизнеса</h3>
          <input id="search-biz" placeholder="Название бизнеса" />
          <div style="margin-top:8px"><button class="btn" id="search-btn">Найти</button></div>
        </div>

      </aside>
    </div>

    <footer>GSK LAND</footer>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // === Вставьте свой firebaseConfig ===
    const firebaseConfig = {
      apiKey: "REPLACE_WITH_YOUR_API_KEY",
      authDomain: "REPLACE_WITH_YOUR_AUTH_DOMAIN",
      projectId: "REPLACE_WITH_YOUR_PROJECT_ID",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Collections used: users, businesses, deals, news

    // UI refs
    const navButtons = document.querySelectorAll('.nav-btn');
    const views = {
      home: document.getElementById('view-home'),
      shop: document.getElementById('view-shop'),
      my: document.getElementById('view-my'),
      rating: document.getElementById('view-rating'),
      news: document.getElementById('view-news'),
      admin: document.getElementById('view-admin')
    };
    navButtons.forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const view = btn.dataset.view;
      Object.values(views).forEach(v=>v.classList.add('hidden'));
      views[view].classList.remove('hidden');
    }));

    // Admin rule: username === 'Spotty' OR email === 'sad.spotty@gmail.com'
    function isAdminUser(userDoc, user){
      if(!user) return false;
      const email = (user && user.email) ? user.email.toLowerCase() : '';
      const username = (userDoc && userDoc.username) ? userDoc.username : (user.displayName||'');
      return username === 'Spotty' || email === 'sad.spotty@gmail.com';
    }

    let currentUser = null; // firebase auth user
    let currentUserDoc = null; // firestore users doc (object with fields)

    // Auth state
    auth.onAuthStateChanged(async (user)=>{
      currentUser = user;
      if(user){
        const uref = db.collection('users').doc(user.uid);
        const snap = await uref.get();
        if(snap.exists){ currentUserDoc = snap.data(); }
        else { const newDoc = { username: user.displayName||'', email:user.email||'', balance:0 }; await uref.set(newDoc); currentUserDoc = newDoc; }
        // UI
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('auth-forms').classList.add('hidden');
        document.getElementById('display-name').innerText = currentUserDoc.username || user.displayName || 'Игрок';
        document.getElementById('display-email').innerText = user.email || '';
        document.getElementById('balance').innerText = String(currentUserDoc.balance || 0);
        // HUD
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('hud-username').innerText = currentUserDoc.username || user.displayName || 'Игрок';
        document.getElementById('hud-email').innerText = user.email || '';
        document.getElementById('hud-balance').innerText = String(currentUserDoc.balance || 0);
        // admin nav
        if(isAdminUser(currentUserDoc, user)){
          document.getElementById('nav-admin').classList.remove('hidden');
          document.getElementById('news-admin').classList.remove('hidden');
        } else {
          document.getElementById('nav-admin').classList.add('hidden');
          document.getElementById('news-admin').classList.add('hidden');
        }
      } else {
        currentUserDoc = null;
        document.getElementById('user-info').classList.add('hidden');
        document.getElementById('auth-forms').classList.remove('hidden');
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('nav-admin').classList.add('hidden');
        document.getElementById('news-admin').classList.add('hidden');
      }
      await renderShop();
      await renderMyBusinesses();
      await renderRating();
    });

    // Register
    document.getElementById('btn-register').addEventListener('click', async ()=>{
      const username = document.getElementById('reg-username').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const pass = document.getElementById('reg-pass').value;
      const pass2 = document.getElementById('reg-pass2').value;
      const codeword = document.getElementById('reg-codeword').value.trim();
      if(!username || !email || !pass || pass!==pass2 || !codeword){ alert('Проверьте данные регистрации'); return; }
      try{
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        await cred.user.updateProfile({ displayName: username });
        await db.collection('users').doc(cred.user.uid).set({ username, email, balance:0, codeword });
        alert('Регистрация успешна');
      }catch(e){ alert(e.message); }
    });

    // Login / Logout
    document.getElementById('btn-login').addEventListener('click', async ()=>{
      const email = document.getElementById('login-email').value.trim();
      const pass = document.getElementById('login-pass').value;
      try{ await auth.signInWithEmailAndPassword(email, pass); }catch(e){ alert(e.message); }
    });
    document.getElementById('btn-logout').addEventListener('click', ()=>auth.signOut());

    // ====== Shop rendering and buy logic ======
    async function renderShop(){
      const list = document.getElementById('shop-list'); list.innerHTML='';
      const snaps = await db.collection('businesses').orderBy('name').get();
      snaps.forEach(doc=>{
        const b = doc.data(); b.id = doc.id;
        const el = document.createElement('div'); el.className='biz-card';
        const ownerText = b.ownerUid ? '<div class="muted small">Занят</div>' : `<button class="btn buy-btn" data-id="${b.id}">Купить</button>`;
        el.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <img src="${b.icon||'https://via.placeholder.com/64/0fb48b/ffffff?text=B'}" width="64" height="64" style="border-radius:8px;object-fit:cover" />
            <div style="flex:1">
              <strong>${b.name}</strong>
              <div class="muted small">Доход/ч: ${b.incomePerHour} • Цена: ${b.price}</div>
            </div>
            <div>${ownerText}</div>
          </div>
        `;
        list.appendChild(el);
      });
      document.querySelectorAll('.buy-btn').forEach(btn=>btn.addEventListener('click', async (e)=>{
        const id = e.target.dataset.id;
        if(!currentUser){ alert('Войдите'); return; }
        const docRef = db.collection('businesses').doc(id);
        try{
          await db.runTransaction(async (tx)=>{
            const d = await tx.get(docRef);
            if(!d.exists) throw new Error('Бизнес не найден');
            const data = d.data();
            if(data.ownerUid) throw new Error('Бизнес уже куплен');
            const uref = db.collection('users').doc(currentUser.uid);
            const usnap = await tx.get(uref);
            const userData = usnap.data();
            if(userData.balance < data.price) throw new Error('Недостаточно средств');
            tx.update(uref, { balance: firebase.firestore.FieldValue.increment(-data.price) });
            tx.update(docRef, { ownerUid: currentUser.uid, lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp() });
          });
          alert('Покупка успешна');
          await refreshUserDoc();
          await renderShop(); await renderMyBusinesses(); await renderRating();
        }catch(err){ alert(err.message||err); }
      }));
    }

    // ====== My businesses & collect income logic ======
    async function renderMyBusinesses(){
      const list = document.getElementById('my-list'); list.innerHTML='';
      if(!currentUser){ list.innerHTML='<div class="muted">Войдите чтобы увидеть свои бизнесы</div>'; return; }
      const snaps = await db.collection('businesses').where('ownerUid','==',currentUser.uid).get();
      if(snaps.empty){ list.innerHTML='<div class="muted">У вас нет бизнесов</div>'; return; }
      snaps.forEach(doc=>{
        const b = doc.data(); b.id = doc.id;
        const last = b.lastCollectedAt ? b.lastCollectedAt.toDate() : new Date();
        const now = new Date();
        const ms = now - last;
        const hours = ms / (1000*60*60);
        const pending = Math.floor(b.incomePerHour * hours);
        const el = document.createElement('div'); el.className='biz-card';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>${b.name}</strong>
              <div class="muted small">Доход/ч: ${b.incomePerHour} • Накоплено: ${pending} ₽</div>
            </div>
            <div class="flex">
              <button class="btn collect-btn" data-id="${b.id}">Собрать</button>
              <button class="btn sell-gov" data-id="${b.id}" style="background:rgba(200,60,60,0.9);margin-left:6px">Продать гос.</button>
              <button class="btn sell-player" data-id="${b.id}" style="background:rgba(120,120,120,0.9);margin-left:6px">Продать игроку</button>
            </div>
          </div>
        `;
        list.appendChild(el);
      });

      document.querySelectorAll('.collect-btn').forEach(btn=>btn.addEventListener('click', async (e)=>{
        const id = e.target.dataset.id;
        if(!currentUser) return alert('Войдите');
        const bizRef = db.collection('businesses').doc(id);
        try{
          await db.runTransaction(async tx=>{
            const snap = await tx.get(bizRef);
            if(!snap.exists) throw new Error('Бизнес не найден');
            const b = snap.data();
            if(b.ownerUid !== currentUser.uid) throw new Error('Вы не владелец');
            const last = b.lastCollectedAt ? b.lastCollectedAt.toDate() : new Date();
            const now = new Date();
            const ms = now - last;
            const hours = ms / (1000*60*60);
            const amount = Math.floor(b.incomePerHour * hours);
            if(amount <= 0) throw new Error('Нет накопленного дохода');
            const uref = db.collection('users').doc(currentUser.uid);
            tx.update(uref, { balance: firebase.firestore.FieldValue.increment(amount) });
            tx.update(bizRef, { lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp() });
          });
          alert('Доход собран');
          await refreshUserDoc();
          await renderMyBusinesses(); renderShop(); renderRating();
        }catch(err){ alert(err.message||err); }
      }));

      document.querySelectorAll('.sell-gov').forEach(btn=>btn.addEventListener('click', async e=>{
        const id = e.target.dataset.id;
        if(!confirm('Продать государству? Вы получите 70% от цены.')) return;
        const bizRef = db.collection('businesses').doc(id);
        try{
          await db.runTransaction(async tx=>{
            const snap = await tx.get(bizRef);
            if(!snap.exists) throw new Error('Не найден');
            const b = snap.data();
            if(b.ownerUid !== currentUser.uid) throw new Error('Вы не владелец');
            const price = Math.floor(b.price * 0.7);
            const uref = db.collection('users').doc(currentUser.uid);
            tx.update(uref, { balance: firebase.firestore.FieldValue.increment(price) });
            tx.update(bizRef, { ownerUid: null, lastCollectedAt: null });
          });
          alert('Продано государству');
          await refreshUserDoc(); renderShop(); renderMyBusinesses(); renderRating();
        }catch(err){ alert(err.message||err); }
      }));

      document.querySelectorAll('.sell-player').forEach(btn=>btn.addEventListener('click', async e=>{
        const id = e.target.dataset.id;
        const bizRef = db.collection('businesses').doc(id);
        const snap = await bizRef.get(); if(!snap.exists) return alert('Не найден');
        const b = snap.data(); const minP = Math.floor(b.price*0.5); const maxP = Math.floor(b.price*2);
        const target = prompt(`Укажите никнейм игрока для продажи (минимум ${minP}, максимум ${maxP})`);
        if(!target) return;
        const usersSnap = await db.collection('users').where('username','==',target).get(); if(usersSnap.empty) return alert('Пользователь не найден');
        const targetDoc = usersSnap.docs[0]; let price = parseInt(prompt('Укажите цену продажи', String(minP)));
        if(isNaN(price) || price<minP || price>maxP) return alert('Цена вне диапазона');
        await db.collection('deals').add({ fromUid: currentUser.uid, toUid: targetDoc.id, bizId: id, price, state:'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        alert('Предложение отправлено');
      }));
    }

    // Collect all
    document.getElementById('collect-all').addEventListener('click', async ()=>{
      if(!currentUser) return alert('Войдите');
      const snaps = await db.collection('businesses').where('ownerUid','==',currentUser.uid).get();
      let total = 0;
      const batch = db.batch();
      for(const doc of snaps.docs){
        const b = doc.data(); const last = b.lastCollectedAt ? b.lastCollectedAt.toDate() : new Date();
        const hours = (new Date() - last) / (1000*60*60);
        const amount = Math.floor(b.incomePerHour * hours);
        if(amount>0){
          total += amount;
          batch.update(db.collection('businesses').doc(doc.id), { lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
      }
      if(total<=0) return alert('Нет накопленного дохода');
      const uref = db.collection('users').doc(currentUser.uid);
      batch.update(uref, { balance: firebase.firestore.FieldValue.increment(total) });
      await batch.commit();
      alert('Собрано: ' + total);
      await refreshUserDoc(); renderMyBusinesses(); renderShop(); renderRating();
    });

    // ====== Deals notifications and accept/reject ======
    db.collection('deals').where('state','==','pending').onSnapshot(async snap=>{
      const noti = document.getElementById('notifications'); noti.innerHTML='';
      if(!currentUser) return;
      for(const doc of snap.docs){
        const d = doc.data(); d.id = doc.id;
        if(d.toUid === currentUser.uid){
          const sellerSnap = await db.collection('users').doc(d.fromUid).get();
          const bizSnap = await db.collection('businesses').doc(d.bizId).get();
          const seller = sellerSnap.data(); const biz = bizSnap.data();
          const el = document.createElement('div'); el.className='muted small';
          el.innerHTML = `Предложение от ${seller.username}: ${biz.name} — цена ${d.price} <button class="btn" data-id="${d.id}">Принять</button> <button class="btn" data-rej="${d.id}" style="background:rgba(120,120,120,0.9);">Отклонить</button>`;
          noti.appendChild(el);
          el.querySelector('[data-id]').addEventListener('click', async ()=>{
            try{
              await db.runTransaction(async tx=>{
                const dealRef = db.collection('deals').doc(d.id);
                const dealSnap = await tx.get(dealRef); if(!dealSnap.exists) throw new Error('Сделка не найдена');
                const deal = dealSnap.data();
                const buyerRef = db.collection('users').doc(currentUser.uid);
                const sellerRef = db.collection('users').doc(deal.fromUid);
                const bizRef = db.collection('businesses').doc(deal.bizId);
                const buyerSnap = await tx.get(buyerRef); const sellerSnap = await tx.get(sellerRef); const bizSnap = await tx.get(bizRef);
                if(buyerSnap.data().balance < deal.price) throw new Error('Недостаточно средств');
                tx.update(buyerRef, { balance: firebase.firestore.FieldValue.increment(-deal.price) });
                tx.update(sellerRef, { balance: firebase.firestore.FieldValue.increment(deal.price) });
                tx.update(bizRef, { ownerUid: currentUser.uid, lastCollectedAt: firebase.firestore.FieldValue.serverTimestamp() });
                tx.update(dealRef, { state:'accepted' });
              });
              alert('Сделка принята'); refreshUserDoc(); renderShop(); renderMyBusinesses(); renderRating();
            }catch(err){ alert(err.message||err); }
          });
          el.querySelector('[data-rej]').addEventListener('click', async ()=>{ await db.collection('deals').doc(d.id).update({ state:'rejected' }); alert('Отклонено'); });
        }
      }
    });

    // ====== Rating ======
    async function renderRating(){
      const el = document.getElementById('rating-list'); el.innerHTML='';
      const snaps = await db.collection('users').get();
      const arr = [];
      snaps.forEach(s=>{ const d=s.data(); arr.push({ username:d.username, balance:d.balance||0 }); });
      arr.sort((a,b)=>b.balance-a.balance);
      arr.slice(0,20).forEach((u,i)=>{
        const div = document.createElement('div'); div.className='card'; div.innerHTML = `<strong>#${i+1} ${u.username}</strong><div class="muted small">Баланс: ${u.balance}</div>`; el.appendChild(div);
      });
    }

    // ====== News: admin publish + realtime list ======
    document.getElementById('news-add').addEventListener('click', async ()=>{
      if(!currentUser) return alert('Войдите');
      if(!isAdminUser(currentUserDoc, currentUser)) return alert('Только админ может публиковать');
      const title = document.getElementById('news-title').value.trim();
      const content = document.getElementById('news-content').value.trim();
      if(!title || !content) return alert('Заполните заголовок и текст');
      await db.collection('news').add({ title, content, author: currentUserDoc.username || currentUser.email || 'admin', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
      document.getElementById('news-title').value=''; document.getElementById('news-content').value='';
      alert('Новость опубликована');
    });

    db.collection('news').orderBy('timestamp','desc').onSnapshot(snap=>{
      const el = document.getElementById('news-list'); el.innerHTML='';
      snap.forEach(doc=>{
        const n = doc.data(); const time = n.timestamp ? n.timestamp.toDate().toLocaleString() : '';
        const div = document.createElement('div'); div.className='news-item';
        div.innerHTML = `<strong>${n.title}</strong><div class="muted small">${n.author} • ${time}</div><div style="margin-top:8px">${n.content}</div>`;
        el.appendChild(div);
      });
    });

    // ====== Search business ======
    document.getElementById('search-btn').addEventListener('click', async ()=>{
      const q = document.getElementById('search-biz').value.trim().toLowerCase();
      const list = document.getElementById('shop-list'); list.innerHTML='';
      const snaps = await db.collection('businesses').get();
      snaps.forEach(doc=>{ const b=doc.data(); if(b.name.toLowerCase().includes(q)){
        const el=document.createElement('div'); el.className='biz-card'; el.innerHTML=`<strong>${b.name}</strong><div class="muted small">Цена: ${b.price}</div>`; list.appendChild(el);
      }});
    });

    // ====== Admin actions ======
    document.getElementById('admin-create-biz').addEventListener('click', async ()=>{
      if(!currentUser || !isAdminUser(currentUserDoc, currentUser)) return alert('Доступно только админу');
      const name = document.getElementById('admin-biz-name').value.trim();
      const price = parseInt(document.getElementById('admin-biz-price').value);
      const income = parseInt(document.getElementById('admin-biz-income').value);
      const icon = document.getElementById('admin-biz-icon').value.trim();
      if(!name || isNaN(price) || isNaN(income)) return alert('Заполните поля корректно');
      await db.collection('businesses').add({ name, price, incomePerHour: income, ownerUid: null, icon: icon||'', lastCollectedAt: null });
      alert('Бизнес создан'); document.getElementById('admin-biz-name').value=''; document.getElementById('admin-biz-price').value=''; document.getElementById('admin-biz-income').value='';
      await renderShop();
    });

    document.getElementById('admin-find-btn').addEventListener('click', async ()=>{
      if(!currentUser || !isAdminUser(currentUserDoc, currentUser)) return alert('Доступно только админу');
      const q = document.getElementById('admin-find-user').value.trim(); if(!q) return;
      const snaps = await db.collection('users').where('username','==',q).get();
      const out = document.getElementById('admin-find-result'); out.innerHTML='';
      if(snaps.empty){ out.innerText='Не найден'; return; }
      const d = snaps.docs[0].data(); out.innerText = `Найден: ${d.username} • ${d.email} • Баланс: ${d.balance}`;
    });

    // ====== Deals clean-up listener (optional) ======
    // (handled above in onSnapshot)

    // ====== Utility: refresh user doc from firestore ======
    async function refreshUserDoc(){
      if(!currentUser) return;
      const snap = await db.collection('users').doc(currentUser.uid).get();
      if(snap.exists){ currentUserDoc = snap.data(); document.getElementById('balance').innerText = String(currentUserDoc.balance||0); document.getElementById('hud-balance').innerText = String(currentUserDoc.balance||0); }
    }

    // ====== Initial demo businesses if none exist (only create if empty) ======
    (async function ensureDemo(){
      const snap = await db.collection('businesses').limit(1).get();
      if(snap.empty){
        await db.collection('businesses').add({ name:'Магазин "У дома"', price:5000, incomePerHour:50, ownerUid:null, icon:'', lastCollectedAt:null });
        await db.collection('businesses').add({ name:'Кинотеатр "Галактика"', price:20000, incomePerHour:300, ownerUid:null, icon:'', lastCollectedAt:null });
        await db.collection('businesses').add({ name:'Кафе "Бочка"', price:8000, incomePerHour:80, ownerUid:null, icon:'', lastCollectedAt:null });
      }
      await renderShop(); await renderRating();
    })();

  </script>
</body>
</html>

